{% extends 'campagne/_layout.html.twig' %}

{% block title %}Operations - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Select inline styling */
    .select-inline {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b6b6b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    .select-inline:focus {
        outline: 2px solid #2563eb;
        outline-offset: -2px;
    }

    /* Dropdown menu */
    .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        z-index: 50;
        min-width: 160px;
    }
    .dropdown-menu.active {
        display: block;
    }

    /* Table row hover */
    .table-row-hover:hover {
        background-color: #fafaf5;
    }
</style>
{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white border-b-4 border-ink">
    <div class="px-10 py-6 flex justify-between items-start">
        <div>
            {# Breadcrumb #}
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <a href="{{ path('app_campagne_index') }}" class="hover:text-ink">Campagnes</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-ink font-medium">{{ campagne.nom }}</span>
            </div>

            {# Title + Status #}
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold tracking-tight">Operations</h1>
                <span class="px-3 py-1 bg-{{ campagne.statutCouleur }} text-white text-[10px] font-bold uppercase tracking-wider">{{ campagne.statutLabel }}</span>
            </div>

            {# Meta #}
            <div class="flex items-center gap-6 mt-3 text-sm text-muted">
                <span class="flex items-center gap-2">
                    <i data-feather="target" class="w-4 h-4"></i>
                    {{ operations|length }} operations affichees
                </span>
                {% if campagne.typeOperation %}
                <span class="flex items-center gap-2">
                    <i data-feather="{{ campagne.typeOperation.icone }}" class="w-4 h-4"></i>
                    {{ campagne.typeOperation.nom }}
                </span>
                {% endif %}
            </div>
        </div>

        {# Actions #}
        <div class="flex items-center gap-3">
            {% if is_granted('ROLE_GESTIONNAIRE') or is_granted('ROLE_COORDINATEUR') or is_granted('ROLE_ADMIN') %}
            <a href="{{ path('app_operation_export', {campagne: campagne.id}) }}"
               class="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-ink border-2 border-ink hover:bg-ink hover:text-white transition-colors">
                <i data-feather="download" class="w-4 h-4"></i>
                Exporter CSV
            </a>
            {% endif %}
            <a href="{{ path('app_campagne_operation_new', {id: campagne.id}) }}" class="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Ajouter
            </a>
        </div>
    </div>

    {# Onglets navigation campagne #}
    {% include 'campagne/_tabs.html.twig' with {campagne: campagne, active: 'operations'} only %}
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="px-10 py-8">

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : 'danger' }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : 'alert-circle' }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : 'danger' }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        {# ========================================
           KPIs STATUTS (RG-080: Triple signalisation)
           ======================================== #}
        <div class="grid grid-cols-6 gap-4 mb-8">
            {% for statut, stat in statistiques %}
            <a href="{{ path('app_operation_index', {campagne: campagne.id, statut: statut}) }}"
               class="bg-white border-2 {{ filtres.statut == statut ? 'border-ink' : 'border-ink/10 hover:border-ink/30' }} p-4 transition-colors">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-{{ stat.couleur }}/10 flex items-center justify-center">
                        <i data-feather="{{ stat.icone }}" class="w-4 h-4 text-{{ stat.couleur }}"></i>
                    </div>
                    <span class="text-2xl font-bold num text-ink">{{ stat.count }}</span>
                </div>
                <p class="text-xs font-medium text-{{ stat.couleur }} uppercase tracking-wide">{{ stat.label }}</p>
            </a>
            {% endfor %}
        </div>

        {# ========================================
           FILTRES
           ======================================== #}
        <form method="get" action="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="mb-6">
            <div class="flex items-center gap-4 bg-white border-2 border-ink/10 p-4">
                {# Recherche #}
                <div class="flex-1 relative">
                    <i data-feather="search" class="w-4 h-4 text-muted absolute left-3 top-1/2 -translate-y-1/2"></i>
                    <input type="text"
                           name="search"
                           value="{{ filtres.search }}"
                           placeholder="Rechercher par matricule ou nom..."
                           class="w-full pl-10 pr-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none transition-colors">
                </div>

                {# Statut #}
                <select name="statut" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les statuts</option>
                    {% for statut, label in constant('App\\Entity\\Operation::STATUTS') %}
                    <option value="{{ statut }}" {{ filtres.statut == statut ? 'selected' : '' }}>{{ label }}</option>
                    {% endfor %}
                </select>

                {# Segment (seulement si pas de colonneSegment defini) #}
                {% if not campagne.colonneSegment and segments|length > 0 %}
                <select name="segment" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les segments</option>
                    <option value="0" {{ filtres.segment_id == 0 ? 'selected' : '' }}>Sans segment</option>
                    {% for segment in segments %}
                    <option value="{{ segment.id }}" {{ filtres.segment_id == segment.id ? 'selected' : '' }}>{{ segment.nom }}</option>
                    {% endfor %}
                </select>
                {% endif %}

                {# Technicien #}
                <select name="technicien" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les techniciens</option>
                    <option value="0" {{ filtres.technicien_id == 0 ? 'selected' : '' }}>Non assigne</option>
                    {% for tech in techniciens %}
                    <option value="{{ tech.id }}" {{ filtres.technicien_id == tech.id ? 'selected' : '' }}>{{ tech.nomComplet }}</option>
                    {% endfor %}
                </select>

                {# Boutons #}
                <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                    Filtrer
                </button>
                {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
                <a href="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="px-4 py-2 text-sm font-medium text-muted hover:text-ink border-2 border-ink/10 hover:border-ink transition-colors">
                    Reinitialiser
                </a>
                {% endif %}
            </div>
        </form>

        {# ========================================
           TABLEAU OPERATIONS
           ======================================== #}
        {% if operations|length > 0 %}
        {# Determiner si on affiche la colonne duree (une seule fois) #}
        {% set showDureeColumn = campagne.saisieTempsActivee or operations|filter(o => o.dureeInterventionMinutes is not null)|length > 0 %}

        <div class="bg-white border-2 border-ink overflow-x-auto">
            <table class="w-full min-w-max">
                <thead class="bg-paper border-b-2 border-ink">
                    <tr>
                        {# Colonnes dynamiques (CampagneChamp) - exclure les colonnes mappees vers datePlanifiee #}
                        {% for champ in champs %}
                            {% if champ.nom != campagne.colonneDatePlanifiee and champ.nom != campagne.colonneHoraire %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider">{{ champ.nom }}</th>
                            {% endif %}
                        {% endfor %}
                        {% if campagne.colonneSegment %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-36">{{ campagne.colonneSegment|upper }}</th>
                        {% endif %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-44">Statut</th>
                        <th class="text-center px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-24">Checklist</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-44">Technicien</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-40">Date/Heure</th>
                        {% if showDureeColumn %}
                        <th class="text-center px-1 py-3 text-xs font-bold text-ink uppercase tracking-wider w-12">Durée</th>
                        {% endif %}
                        {% if campagne.reservationOuverte %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-36">Reserve par</th>
                        {% endif %}
                        <th class="px-4 py-3 w-16"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-ink/10">
                    {% for operation in operations %}
                    <tr class="table-row-hover" data-operation-id="{{ operation.id }}">
                        {# Colonnes dynamiques (CampagneChamp) - exclure les colonnes mappees vers datePlanifiee #}
                        {% set firstVisible = true %}
                        {% for champ in champs %}
                            {% if champ.nom != campagne.colonneDatePlanifiee and champ.nom != campagne.colonneHoraire %}
                        <td class="px-4 py-3 text-sm {% if firstVisible %}font-medium{% endif %} text-ink">
                            {{ operation.getDonneePersonnalisee(champ.nom) ?? '-' }}
                        </td>
                                {% set firstVisible = false %}
                            {% endif %}
                        {% endfor %}

                        {# Segment (seulement si colonneSegment defini) #}
                        {% if campagne.colonneSegment %}
                        <td class="px-4 py-3">
                            {% if operation.donneesPersonnalisees[campagne.colonneSegment] is defined %}
                                <span class="text-xs font-medium text-ink">{{ operation.donneesPersonnalisees[campagne.colonneSegment] }}</span>
                            {% else %}
                                <span class="text-xs text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endif %}

                        {# Statut avec select inline - modale partagee pour report #}
                        <td class="px-4 py-3">
                            <form id="form-statut-{{ operation.id }}"
                                  action="{{ path('app_operation_update_statut', {campagne: campagne.id, id: operation.id}) }}"
                                  method="post"
                                  class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_statut_' ~ operation.id) }}">
                                <select name="statut"
                                        data-previous="{{ operation.statut }}"
                                        data-operation-id="{{ operation.id }}"
                                        data-operation-nom="{{ operation.displayName|default(operation.displayIdentifier)|default('') }}"
                                        data-operation-date="{{ operation.datePlanifiee ? operation.datePlanifiee|date('Y-m-d') : '' }}"
                                        data-operation-heure="{{ operation.datePlanifiee ? operation.datePlanifiee|date('H:i') : '09:00' }}"
                                        data-operation-date-initiale="{{ operation.datePlanifieeInitiale ? operation.datePlanifieeInitiale|format_datetime('medium', 'short', locale='fr') : '' }}"
                                        data-operation-nb-reports="{{ operation.nombreReports|default(0) }}"
                                        data-operation-motif="{{ operation.motifReport|default('') }}"
                                        data-reporter-url="{{ path('app_operation_transition', {campagne: campagne.id, id: operation.id, transition: 'reporter'}) }}"
                                        data-csrf-token="{{ csrf_token('operation_transition_' ~ operation.id) }}"
                                        onchange="handleStatutChange(this)"
                                        class="select-inline text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-{{ operation.statutCouleur }}/10 text-{{ operation.statutCouleur }} font-bold uppercase tracking-wider min-w-[120px]">
                                    {% for statut, label in constant('App\\Entity\\Operation::STATUTS') %}
                                    <option value="{{ statut }}" {{ operation.statut == statut ? 'selected' : '' }}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>

                        {# Checklist progression - total depuis campagne, completed depuis instance #}
                        <td class="px-4 py-3 text-center">
                            {% set total = campagne.nombreEtapesActives %}
                            {% if total > 0 %}
                                {% set completed = operation.checklistInstance ? operation.checklistInstance.nombreEtapesCochees : 0 %}
                                {% set pct = ((completed / total) * 100)|round %}
                                <a href="{{ path('app_operation_show', {campagne: campagne.id, id: operation.id}) }}#checklist"
                                   class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium {% if pct == 100 %}bg-success/10 text-success{% elseif pct > 0 %}bg-primary/10 text-primary{% else %}bg-muted/10 text-muted{% endif %} hover:opacity-80 transition-opacity"
                                   title="Voir la checklist">
                                    <i data-feather="check-square" class="w-3 h-3"></i>
                                    <span class="num">{{ completed }}/{{ total }}</span>
                                </a>
                            {% else %}
                                <span class="text-xs text-muted">-</span>
                            {% endif %}
                        </td>

                        {# Technicien avec select inline #}
                        <td class="px-4 py-3">
                            <form action="{{ path('app_operation_assigner', {campagne: campagne.id, id: operation.id}) }}" method="post" class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_assigner_' ~ operation.id) }}">
                                <select name="technicien_id"
                                        onchange="this.form.submit()"
                                        class="select-inline text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-white min-w-[140px]">
                                    <option value="">Non assigne</option>
                                    {% for tech in techniciens %}
                                    <option value="{{ tech.id }}" {{ operation.technicienAssigne and operation.technicienAssigne.id == tech.id ? 'selected' : '' }}>
                                        {{ tech.nomComplet }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>

                        {# Date et heure avec input inline #}
                        <td class="px-4 py-3">
                            <form action="{{ path('app_operation_update_date', {campagne: campagne.id, id: operation.id}) }}" method="post" class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_date_' ~ operation.id) }}">
                                <input type="datetime-local"
                                       name="date_planifiee"
                                       value="{{ operation.datePlanifiee ? operation.datePlanifiee|date('Y-m-d\\TH:i') : '' }}"
                                       onchange="this.form.submit()"
                                       class="text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-white cursor-pointer min-w-[150px]"
                                       title="Cliquer pour modifier la date et l'heure">
                            </form>
                        </td>

                        {# Duree - colonne fixe compacte #}
                        {% if showDureeColumn %}
                        <td class="px-1 py-3 text-center w-12">
                            {% if operation.dureeInterventionMinutes is not null %}
                                <span class="text-xs font-medium text-purple-700">{{ operation.dureeFormatee }}</span>
                            {% else %}
                                <span class="text-xs text-muted">—</span>
                            {% endif %}
                        </td>
                        {% endif %}

                        {# Reserve par (seulement si reservation ouverte) #}
                        {% if campagne.reservationOuverte %}
                        <td class="px-4 py-3">
                            {% set nbReservations = operation.placesReservees %}
                            {% set capacite = operation.capacite %}
                            {% if campagne.isMultiPlaces or capacite > 1 %}
                                {# Mode multi-places : toujours afficher X/Y #}
                                <span class="text-xs font-semibold text-{{ operation.couleurRemplissage }}">
                                    {{ nbReservations }}/{{ capacite }}
                                </span>
                            {% elseif nbReservations > 0 %}
                                {# Mode simple avec reservation #}
                                {% set firstReservation = operation.reservationsEndUser|first %}
                                <span class="text-primary font-medium text-xs">{{ firstReservation ? firstReservation.nomPrenom : '-' }}</span>
                            {% else %}
                                <span class="text-muted text-xs">-</span>
                            {% endif %}
                        </td>
                        {% endif %}

                        {# Actions #}
                        <td class="px-4 py-3 text-right">
                            <div class="relative" data-controller="dropdown">
                                <button type="button"
                                        data-action="dropdown#toggle"
                                        class="w-8 h-8 border border-ink/10 inline-flex items-center justify-center text-muted hover:bg-ink hover:text-white hover:border-ink transition-colors">
                                    <i data-feather="more-horizontal" class="w-4 h-4"></i>
                                </button>
                                <div class="dropdown-menu" data-dropdown-target="menu">
                                    <div class="bg-white border-2 border-ink shadow-lg py-1">
                                        <a href="{{ path('app_operation_show', {campagne: campagne.id, id: operation.id}) }}" class="block px-4 py-2 text-sm text-ink hover:bg-paper transition-colors">
                                            <span class="flex items-center gap-2">
                                                <i data-feather="eye" class="w-4 h-4"></i>
                                                Voir details
                                            </span>
                                        </a>
                                        <a href="{{ path('app_operation_edit', {campagne: campagne.id, id: operation.id}) }}" class="block px-4 py-2 text-sm text-ink hover:bg-paper transition-colors">
                                            <span class="flex items-center gap-2">
                                                <i data-feather="edit-2" class="w-4 h-4"></i>
                                                Modifier
                                            </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-white border-2 border-ink/20 border-dashed p-12 text-center">
            <div class="w-16 h-16 mx-auto bg-primary/10 flex items-center justify-center mb-4">
                <i data-feather="inbox" class="w-8 h-8 text-primary"></i>
            </div>
            <h3 class="text-lg font-bold text-ink mb-2">Aucune operation trouvee</h3>
            <p class="text-sm text-muted mb-6">
                {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
                Aucune operation ne correspond aux filtres selectionnes.
                {% else %}
                Commencez par ajouter des operations a cette campagne.
                {% endif %}
            </p>
            {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
            <a href="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold border-2 border-ink hover:bg-ink hover:text-white transition-colors">
                Reinitialiser les filtres
            </a>
            {% else %}
            <a href="{{ path('app_campagne_operation_new', {id: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Ajouter une operation
            </a>
            {% endif %}
        </div>
        {% endif %}

    </div>
</div>

{# ============================================= #}
{# MODALE UNIQUE DE REPORT (partagee)            #}
{# ============================================= #}
<div id="modal-reporter-shared"
     class="hidden fixed inset-0 bg-ink/50 z-50 items-center justify-center p-4"
     onclick="if(event.target === this) closeReporterModal()">
    <div class="bg-white border-2 border-ink w-full max-w-md" onclick="event.stopPropagation()">

        {# Header #}
        <div class="px-6 py-4 border-b-2 border-ink/10">
            <h3 class="text-lg font-bold text-ink flex items-center gap-2">
                <i data-feather="pause-circle" class="w-5 h-5 text-warning"></i>
                Reporter : <span id="modal-reporter-nom" class="ml-1"></span>
            </h3>
        </div>

        {# Body #}
        <form id="modal-reporter-form" method="POST" class="p-6">
            <input type="hidden" name="_token" id="modal-reporter-token" value="">

            {# Info RDV actuel #}
            <div id="modal-reporter-info-rdv" class="mb-4 p-3 bg-primary/10 border border-primary/20 hidden">
                <p class="text-sm text-ink">
                    <strong>RDV actuel :</strong> <span id="modal-reporter-date-actuelle"></span>
                </p>
                <p id="modal-reporter-historique" class="text-xs text-muted mt-1 hidden"></p>
            </div>

            {# Motif #}
            <div class="mb-4">
                <label class="block text-sm font-medium text-ink mb-2">
                    Motif du report <span class="text-muted text-xs">(optionnel)</span>
                </label>
                <textarea name="motif"
                          id="modal-reporter-motif"
                          rows="2"
                          class="w-full px-3 py-2 border-2 border-ink/20 focus:border-warning outline-none text-sm"
                          placeholder="Agent absent, materiel indisponible..."></textarea>
            </div>

            {# Nouvelle date #}
            <div class="mb-4">
                <label class="block text-sm font-medium text-ink mb-2">
                    Nouveau creneau <span class="text-muted text-xs">(optionnel)</span>
                </label>
                <p class="text-xs text-muted mb-2">
                    Si non renseigne, l'intervention restera sans date assignee.
                </p>
                <div class="flex gap-2">
                    <input type="date"
                           name="nouvelle_date"
                           id="modal-reporter-nouvelle-date"
                           min="{{ 'now'|date('Y-m-d') }}"
                           class="flex-1 px-3 py-2 border-2 border-ink/20 focus:border-warning outline-none text-sm">
                    <input type="time"
                           name="nouvelle_heure"
                           id="modal-reporter-nouvelle-heure"
                           value="09:00"
                           class="w-28 px-3 py-2 border-2 border-ink/20 focus:border-warning outline-none text-sm">
                </div>
            </div>

            {# Boutons #}
            <div class="flex gap-3 pt-4 border-t border-ink/10">
                <button type="button"
                        onclick="closeReporterModal()"
                        class="flex-1 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors">
                    Annuler
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-2 text-sm font-semibold text-white bg-warning hover:bg-warning/90 transition-colors">
                    Confirmer
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
// === MODALS ===
// Note: Les dropdowns sont geres par le controller Stimulus dropdown_controller.js
function initModals() {
    // Open modal buttons
    document.querySelectorAll('[data-modal-open]:not([data-modal-init])').forEach(function(btn) {
        btn.setAttribute('data-modal-init', 'true');

        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const modalId = btn.getAttribute('data-modal-open');
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        });
    });

    // Close modal buttons
    document.querySelectorAll('[data-modal-close]:not([data-modal-close-init])').forEach(function(btn) {
        btn.setAttribute('data-modal-close-init', 'true');

        btn.addEventListener('click', function() {
            const modal = btn.closest('[data-modal]');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
    });

    // Close modal on backdrop click
    document.querySelectorAll('[data-modal]:not([data-modal-backdrop-init])').forEach(function(modal) {
        modal.setAttribute('data-modal-backdrop-init', 'true');

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
    });
}

// === STATUT REPORT MODAL (modale partagee) ===
/**
 * Gere le changement de statut avec modale partagee pour les reports
 */
function handleStatutChange(select) {
    const newValue = select.value;
    const previousValue = select.dataset.previous;

    // Pas de changement = rien a faire
    if (newValue === previousValue) {
        return;
    }

    // Si on selectionne "reporte", TOUJOURS ouvrir la modale
    // Le backend validera si la transition est possible
    if (newValue === 'reporte') {
        // Annuler le changement dans le select
        select.value = previousValue;

        // Ouvrir la modale partagee
        openReporterModal(select);
    } else {
        // Changement normal - soumettre le formulaire
        select.dataset.previous = newValue;
        select.form.submit();
    }
}

/**
 * Ouvre la modale partagee et la remplit avec les donnees de l'operation
 */
function openReporterModal(select) {
    const modal = document.getElementById('modal-reporter-shared');
    const form = document.getElementById('modal-reporter-form');

    // Recuperer les donnees depuis les data-attributes
    const operationId = select.dataset.operationId;
    const nom = select.dataset.operationNom;
    const dateActuelle = select.dataset.operationDate;
    const heureActuelle = select.dataset.operationHeure;
    const dateInitiale = select.dataset.operationDateInitiale;
    const nbReports = parseInt(select.dataset.operationNbReports) || 0;
    const motif = select.dataset.operationMotif;
    const reporterUrl = select.dataset.reporterUrl;
    const csrfToken = select.dataset.csrfToken;

    // Remplir le formulaire
    form.action = reporterUrl;
    document.getElementById('modal-reporter-token').value = csrfToken;

    // Remplir les infos
    document.getElementById('modal-reporter-nom').textContent = nom || '#' + operationId;
    document.getElementById('modal-reporter-motif').value = motif || '';
    document.getElementById('modal-reporter-nouvelle-date').value = '';
    document.getElementById('modal-reporter-nouvelle-heure').value = heureActuelle || '09:00';

    // Afficher info RDV actuel si existe
    const infoRdv = document.getElementById('modal-reporter-info-rdv');
    const dateActuelleSpan = document.getElementById('modal-reporter-date-actuelle');
    const historique = document.getElementById('modal-reporter-historique');

    if (dateActuelle) {
        infoRdv.classList.remove('hidden');
        // Formater la date pour affichage
        const dateObj = new Date(dateActuelle + 'T' + (heureActuelle || '09:00'));
        dateActuelleSpan.textContent = dateObj.toLocaleDateString('fr-FR', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        // Historique des reports
        if (nbReports > 0 && dateInitiale) {
            historique.classList.remove('hidden');
            historique.textContent = 'Date initiale : ' + dateInitiale + ' — ' + nbReports + ' report' + (nbReports > 1 ? 's' : '');
        } else {
            historique.classList.add('hidden');
        }
    } else {
        infoRdv.classList.add('hidden');
    }

    // Afficher la modale
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // Focus sur le champ motif
    setTimeout(function() {
        document.getElementById('modal-reporter-motif').focus();
    }, 100);
}

/**
 * Ferme la modale partagee
 */
function closeReporterModal() {
    const modal = document.getElementById('modal-reporter-shared');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// Fermer avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeReporterModal();
    }
});

// === INIT ===
function initAllInteractions() {
    initModals();
}

document.addEventListener('DOMContentLoaded', initAllInteractions);
document.addEventListener('turbo:render', initAllInteractions);
</script>
{% endblock %}
