{% extends 'campagne/_layout.html.twig' %}

{% block title %}Operations - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Select inline styling */
    .select-inline {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b6b6b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    .select-inline:focus {
        outline: 2px solid #2563eb;
        outline-offset: -2px;
    }

    /* Dropdown menu */
    .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        z-index: 50;
        min-width: 160px;
    }
    .dropdown-menu.active {
        display: block;
    }

    /* Table row hover */
    .table-row-hover:hover {
        background-color: #fafaf5;
    }
</style>
{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white border-b-4 border-ink">
    <div class="px-10 py-6 flex justify-between items-start">
        <div>
            {# Breadcrumb #}
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <a href="{{ path('app_campagne_index') }}" class="hover:text-ink">Campagnes</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-ink font-medium">{{ campagne.nom }}</span>
            </div>

            {# Title + Status #}
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold tracking-tight">Operations</h1>
                <span class="px-3 py-1 bg-{{ campagne.statutCouleur }} text-white text-[10px] font-bold uppercase tracking-wider">{{ campagne.statutLabel }}</span>
            </div>

            {# Meta #}
            <div class="flex items-center gap-6 mt-3 text-sm text-muted">
                <span class="flex items-center gap-2">
                    <i data-feather="target" class="w-4 h-4"></i>
                    {{ operations|length }} operations affichees
                </span>
                {% if campagne.typeOperation %}
                <span class="flex items-center gap-2">
                    <i data-feather="{{ campagne.typeOperation.icone }}" class="w-4 h-4"></i>
                    {{ campagne.typeOperation.nom }}
                </span>
                {% endif %}
            </div>
        </div>

        {# Actions #}
        <div class="flex items-center gap-3">
            <a href="{{ path('app_campagne_operation_new', {id: campagne.id}) }}" class="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Ajouter
            </a>
        </div>
    </div>

    {# Onglets navigation campagne #}
    {% include 'campagne/_tabs.html.twig' with {campagne: campagne, active: 'operations'} only %}
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="px-10 py-8">

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : 'danger' }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : 'alert-circle' }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : 'danger' }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        {# ========================================
           KPIs STATUTS (RG-080: Triple signalisation)
           ======================================== #}
        <div class="grid grid-cols-6 gap-4 mb-8">
            {% for statut, stat in statistiques %}
            <a href="{{ path('app_operation_index', {campagne: campagne.id, statut: statut}) }}"
               class="bg-white border-2 {{ filtres.statut == statut ? 'border-ink' : 'border-ink/10 hover:border-ink/30' }} p-4 transition-colors">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-{{ stat.couleur }}/10 flex items-center justify-center">
                        <i data-feather="{{ stat.icone }}" class="w-4 h-4 text-{{ stat.couleur }}"></i>
                    </div>
                    <span class="text-2xl font-bold num text-ink">{{ stat.count }}</span>
                </div>
                <p class="text-xs font-medium text-{{ stat.couleur }} uppercase tracking-wide">{{ stat.label }}</p>
            </a>
            {% endfor %}
        </div>

        {# ========================================
           FILTRES
           ======================================== #}
        <form method="get" action="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="mb-6">
            <div class="flex items-center gap-4 bg-white border-2 border-ink/10 p-4">
                {# Recherche #}
                <div class="flex-1 relative">
                    <i data-feather="search" class="w-4 h-4 text-muted absolute left-3 top-1/2 -translate-y-1/2"></i>
                    <input type="text"
                           name="search"
                           value="{{ filtres.search }}"
                           placeholder="Rechercher par matricule ou nom..."
                           class="w-full pl-10 pr-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none transition-colors">
                </div>

                {# Statut #}
                <select name="statut" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les statuts</option>
                    {% for statut, label in constant('App\\Entity\\Operation::STATUTS') %}
                    <option value="{{ statut }}" {{ filtres.statut == statut ? 'selected' : '' }}>{{ label }}</option>
                    {% endfor %}
                </select>

                {# Segment #}
                <select name="segment" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les segments</option>
                    <option value="0" {{ filtres.segment_id == 0 ? 'selected' : '' }}>Sans segment</option>
                    {% for segment in segments %}
                    <option value="{{ segment.id }}" {{ filtres.segment_id == segment.id ? 'selected' : '' }}>{{ segment.nom }}</option>
                    {% endfor %}
                </select>

                {# Technicien #}
                <select name="technicien" class="px-4 py-2 border-2 border-ink/10 focus:border-ink text-sm outline-none select-inline bg-white min-w-[150px]">
                    <option value="">Tous les techniciens</option>
                    <option value="0" {{ filtres.technicien_id == 0 ? 'selected' : '' }}>Non assigne</option>
                    {% for tech in techniciens %}
                    <option value="{{ tech.id }}" {{ filtres.technicien_id == tech.id ? 'selected' : '' }}>{{ tech.nomComplet }}</option>
                    {% endfor %}
                </select>

                {# Boutons #}
                <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                    Filtrer
                </button>
                {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
                <a href="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="px-4 py-2 text-sm font-medium text-muted hover:text-ink border-2 border-ink/10 hover:border-ink transition-colors">
                    Reinitialiser
                </a>
                {% endif %}
            </div>
        </form>

        {# ========================================
           TABLEAU OPERATIONS
           ======================================== #}
        {% if operations|length > 0 %}
        <div class="bg-white border-2 border-ink overflow-hidden">
            <table class="w-full">
                <thead class="bg-paper border-b-2 border-ink">
                    <tr>
                        {# Colonnes dynamiques (CampagneChamp) - toutes les donnees viennent de la #}
                        {% for champ in champs %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider">{{ champ.nom }}</th>
                        {% endfor %}
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-36">Segment</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-44">Statut</th>
                        <th class="text-center px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-24">Checklist</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-44">Technicien</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-40">Date/Heure</th>
                        <th class="text-left px-4 py-3 text-xs font-bold text-ink uppercase tracking-wider w-36">Reserve par</th>
                        <th class="px-4 py-3 w-16"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-ink/10">
                    {% for operation in operations %}
                    <tr class="table-row-hover" data-operation-id="{{ operation.id }}">
                        {# Colonnes dynamiques (CampagneChamp) - toutes les donnees viennent de la #}
                        {% for champ in champs %}
                        <td class="px-4 py-3 text-sm {% if loop.first %}font-medium{% endif %} text-ink">
                            {{ operation.getDonneePersonnalisee(champ.nom) ?? '-' }}
                        </td>
                        {% endfor %}

                        {# Segment #}
                        <td class="px-4 py-3">
                            {% if operation.segment %}
                            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 bg-{{ operation.segment.couleur }}/10 text-{{ operation.segment.couleur }} text-xs font-medium">
                                <span class="w-1.5 h-1.5 bg-{{ operation.segment.couleur }}"></span>
                                {{ operation.segment.nom }}
                            </span>
                            {% else %}
                            <span class="text-xs text-muted">-</span>
                            {% endif %}
                        </td>

                        {# Statut avec select inline - tous les statuts disponibles #}
                        <td class="px-4 py-3">
                            <form action="{{ path('app_operation_update_statut', {campagne: campagne.id, id: operation.id}) }}" method="post" class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_statut_' ~ operation.id) }}">
                                <select name="statut"
                                        onchange="this.form.submit()"
                                        class="select-inline text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-{{ operation.statutCouleur }}/10 text-{{ operation.statutCouleur }} font-bold uppercase tracking-wider min-w-[120px]">
                                    {% for statut, label in constant('App\\Entity\\Operation::STATUTS') %}
                                    <option value="{{ statut }}" {{ operation.statut == statut ? 'selected' : '' }}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>

                        {# Checklist progression #}
                        <td class="px-4 py-3 text-center">
                            {% if operation.checklistInstance %}
                                {% set completed = operation.checklistInstance.nombreEtapesCochees %}
                                {% set total = operation.checklistInstance.nombreTotalEtapes %}
                                {% set pct = total > 0 ? ((completed / total) * 100)|round : 0 %}
                                <a href="{{ path('app_operation_show', {campagne: campagne.id, id: operation.id}) }}#checklist"
                                   class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium {% if pct == 100 %}bg-success/10 text-success{% elseif pct > 0 %}bg-primary/10 text-primary{% else %}bg-muted/10 text-muted{% endif %} hover:opacity-80 transition-opacity"
                                   title="Voir la checklist">
                                    <i data-feather="check-square" class="w-3 h-3"></i>
                                    <span class="num">{{ completed }}/{{ total }}</span>
                                </a>
                            {% else %}
                                <span class="text-xs text-muted">-</span>
                            {% endif %}
                        </td>

                        {# Technicien avec select inline #}
                        <td class="px-4 py-3">
                            <form action="{{ path('app_operation_assigner', {campagne: campagne.id, id: operation.id}) }}" method="post" class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_assigner_' ~ operation.id) }}">
                                <select name="technicien_id"
                                        onchange="this.form.submit()"
                                        class="select-inline text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-white min-w-[140px]">
                                    <option value="">Non assigne</option>
                                    {% for tech in techniciens %}
                                    <option value="{{ tech.id }}" {{ operation.technicienAssigne and operation.technicienAssigne.id == tech.id ? 'selected' : '' }}>
                                        {{ tech.nomComplet }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>

                        {# Date et heure avec input inline #}
                        <td class="px-4 py-3">
                            <form action="{{ path('app_operation_update_date', {campagne: campagne.id, id: operation.id}) }}" method="post" class="inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('operation_date_' ~ operation.id) }}">
                                <input type="datetime-local"
                                       name="date_planifiee"
                                       value="{{ operation.datePlanifiee ? operation.datePlanifiee|date('Y-m-d\\TH:i') : '' }}"
                                       onchange="this.form.submit()"
                                       class="text-xs px-2 py-1 border border-ink/10 focus:border-ink bg-white cursor-pointer min-w-[150px]"
                                       title="Cliquer pour modifier la date et l'heure">
                            </form>
                        </td>

                        {# Reserve par #}
                        <td class="px-4 py-3">
                            {% if operation.reservePar %}
                                <span class="text-primary font-medium">{{ operation.reserveParNomComplet }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>

                        {# Actions #}
                        <td class="px-4 py-3 text-right">
                            <div class="relative" data-controller="dropdown">
                                <button type="button"
                                        data-action="dropdown#toggle"
                                        class="w-8 h-8 border border-ink/10 inline-flex items-center justify-center text-muted hover:bg-ink hover:text-white hover:border-ink transition-colors">
                                    <i data-feather="more-horizontal" class="w-4 h-4"></i>
                                </button>
                                <div class="dropdown-menu" data-dropdown-target="menu">
                                    <div class="bg-white border-2 border-ink shadow-lg py-1">
                                        <a href="{{ path('app_operation_show', {campagne: campagne.id, id: operation.id}) }}" class="block px-4 py-2 text-sm text-ink hover:bg-paper transition-colors">
                                            <span class="flex items-center gap-2">
                                                <i data-feather="eye" class="w-4 h-4"></i>
                                                Voir details
                                            </span>
                                        </a>
                                        <a href="{{ path('app_operation_edit', {campagne: campagne.id, id: operation.id}) }}" class="block px-4 py-2 text-sm text-ink hover:bg-paper transition-colors">
                                            <span class="flex items-center gap-2">
                                                <i data-feather="edit-2" class="w-4 h-4"></i>
                                                Modifier
                                            </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-white border-2 border-ink/20 border-dashed p-12 text-center">
            <div class="w-16 h-16 mx-auto bg-primary/10 flex items-center justify-center mb-4">
                <i data-feather="inbox" class="w-8 h-8 text-primary"></i>
            </div>
            <h3 class="text-lg font-bold text-ink mb-2">Aucune operation trouvee</h3>
            <p class="text-sm text-muted mb-6">
                {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
                Aucune operation ne correspond aux filtres selectionnes.
                {% else %}
                Commencez par ajouter des operations a cette campagne.
                {% endif %}
            </p>
            {% if filtres.statut or filtres.segment_id or filtres.technicien_id or filtres.search %}
            <a href="{{ path('app_operation_index', {campagne: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold border-2 border-ink hover:bg-ink hover:text-white transition-colors">
                Reinitialiser les filtres
            </a>
            {% else %}
            <a href="{{ path('app_campagne_operation_new', {id: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Ajouter une operation
            </a>
            {% endif %}
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
// === MODALS ===
// Note: Les dropdowns sont geres par le controller Stimulus dropdown_controller.js
function initModals() {
    // Open modal buttons
    document.querySelectorAll('[data-modal-open]:not([data-modal-init])').forEach(function(btn) {
        btn.setAttribute('data-modal-init', 'true');

        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const modalId = btn.getAttribute('data-modal-open');
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        });
    });

    // Close modal buttons
    document.querySelectorAll('[data-modal-close]:not([data-modal-close-init])').forEach(function(btn) {
        btn.setAttribute('data-modal-close-init', 'true');

        btn.addEventListener('click', function() {
            const modal = btn.closest('[data-modal]');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
    });

    // Close modal on backdrop click
    document.querySelectorAll('[data-modal]:not([data-modal-backdrop-init])').forEach(function(modal) {
        modal.setAttribute('data-modal-backdrop-init', 'true');

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
    });
}

// === INIT ===
function initAllInteractions() {
    initModals();
}

document.addEventListener('DOMContentLoaded', initAllInteractions);
document.addEventListener('turbo:render', initAllInteractions);
</script>
{% endblock %}
