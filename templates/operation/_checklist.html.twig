{#
    Composant Checklist pour l'interface gestionnaire (Sophie/Admin)

    Reutilise la logique du terrain mais avec le style desktop
    et les routes du OperationController.

    Architecture retroactive :
    - Les etapes desactivees sont affichees en grise
    - Les etapes desactivees ne sont pas cliquables
    - Si une etape etait cochee avant desactivation, la coche reste visible en grise
#}
<turbo-frame id="checklist-frame">
    {% set instance = operation.checklistInstance %}
    {% set progression = checklist_progression %}

    {% if instance and progression %}
        {# En-tete avec progression #}
        <div class="px-6 py-4 border-b-2 border-ink/10 flex items-center justify-between">
            <h2 class="font-bold text-ink flex items-center gap-2">
                <i data-feather="check-square" class="w-4 h-4"></i>
                Checklist
            </h2>
            <div class="flex items-center gap-4">
                <span class="text-sm font-bold text-ink">{{ progression.completed }}/{{ progression.total }} etapes</span>
                <span class="text-xs text-muted">({{ progression.percentage }}%)</span>
            </div>
        </div>

        <div class="p-6">
            {# Barre de progression segmentee #}
            {% if progression.total > 0 %}
            <div class="h-2 bg-paper border border-ink/10 flex overflow-hidden mb-6">
                {% for i in 1..progression.total %}
                    <div class="h-full {% if i <= progression.completed %}bg-success{% else %}bg-paper{% endif %}" style="width: {{ (100 / progression.total)|round(2) }}%"></div>
                {% endfor %}
            </div>
            {% else %}
            <div class="h-2 bg-success border border-ink/10 mb-6"></div>
            {% endif %}

            {# Liste des phases et etapes #}
            {% for phaseId, phaseStats in progression.phases %}
                {% set isAccessible = phaseStats.is_accessible ?? true %}

                <div class="mb-6 last:mb-0">
                    {# En-tete de phase #}
                    <h3 class="text-xs text-muted uppercase tracking-wider font-semibold mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 {% if isAccessible %}bg-ink{% else %}bg-muted{% endif %} text-white text-[10px] font-bold flex items-center justify-center">
                            {{ loop.index }}
                        </span>
                        {{ phaseStats.nom }}
                        {% if phaseStats.verrouillable|default(false) and not isAccessible %}
                            <i data-feather="lock" class="w-3 h-3 text-muted" title="Phase verrouillee"></i>
                        {% endif %}
                        {% if phaseStats.is_complete %}
                            <i data-feather="check-circle" class="w-4 h-4 text-success"></i>
                        {% endif %}
                        <span class="ml-auto text-muted font-normal">{{ phaseStats.completed ?? 0 }}/{{ phaseStats.total ?? 0 }}</span>
                    </h3>

                    {# Etapes de la phase #}
                    <div class="space-y-2">
                        {% for etape in phaseStats.etapes|default([]) %}
                            {% set isActif = etape.actif|default(true) %}
                            {% set isCochee = etape.cochee|default(false) %}
                            {% set cocheeMaisDesactivee = etape.cocheeMaisDesactivee|default(false) %}

                            {# ETAPE DESACTIVEE #}
                            {% if not isActif %}
                            <div class="border border-muted/30 bg-muted/5 opacity-50">
                                <div class="flex items-center gap-3 p-3">
                                    {# Checkbox grisee - pas de formulaire #}
                                    <div class="w-6 h-6 border-2 border-muted bg-muted/20 flex items-center justify-center flex-shrink-0 cursor-not-allowed">
                                        {% if cocheeMaisDesactivee %}
                                            <svg class="w-4 h-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        {% endif %}
                                    </div>

                                    {# Texte grise #}
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-muted line-through">
                                            {{ etape.titre }}
                                            {% if not etape.obligatoire|default(true) %}
                                                <span class="text-xs font-normal">(optionnel)</span>
                                            {% endif %}
                                        </p>
                                        {% if etape.description %}
                                            <p class="text-xs text-muted/60">{{ etape.description }}</p>
                                        {% endif %}
                                        <span class="text-xs text-muted italic">Etape desactivee</span>
                                    </div>
                                </div>
                            </div>

                            {# ETAPE ACTIVE #}
                            {% else %}
                            <div class="border {% if isCochee %}border-success/30 bg-success/5{% else %}border-ink/10{% endif %} {% if not isAccessible %}opacity-50{% endif %}">
                                <form action="{{ path('app_operation_checklist_toggle', {campagne: campagne.id, id: operation.id, etapeId: etape.id}) }}"
                                      method="post"
                                      data-turbo-frame="checklist-frame"
                                      class="flex items-center gap-3 p-3">
                                    <input type="hidden" name="_token" value="{{ csrf_token('checklist_' ~ operation.id) }}">

                                    {# Checkbox #}
                                    <button type="submit"
                                            class="w-6 h-6 border-2 {% if isCochee %}bg-success border-success{% else %}border-ink/30 hover:border-ink{% endif %} flex items-center justify-center flex-shrink-0 transition-colors"
                                            {% if not isAccessible %}disabled{% endif %}
                                            title="{{ isCochee ? 'Decocher' : 'Cocher' }}">
                                        {% if isCochee %}
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        {% endif %}
                                    </button>

                                    {# Texte de l'etape #}
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-ink {% if isCochee %}line-through text-muted{% endif %}">
                                            {{ etape.titre }}
                                            {% if not etape.obligatoire|default(true) %}
                                                <span class="text-xs text-muted font-normal">(optionnel)</span>
                                            {% endif %}
                                        </p>
                                        {% if etape.description %}
                                            <p class="text-xs text-muted">{{ etape.description }}</p>
                                        {% endif %}
                                    </div>

                                    {# Lien document si present #}
                                    {% if etape.documentId|default(null) %}
                                        {% set doc = documents[etape.documentId|default(0)]|default(null) %}
                                        {% if doc %}
                                            <a href="{{ path('app_document_download', {campagneId: campagne.id, id: doc.id}) }}"
                                               class="p-1.5 text-primary hover:bg-primary/10 transition-colors"
                                               title="Telecharger : {{ doc.nomOriginal }}"
                                               target="_blank">
                                                <i data-feather="{{ doc.icone ?? 'file' }}" class="w-4 h-4"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </form>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        {# Reinitialiser les icones Feather apres update Turbo #}
        <script>
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        </script>
    {% else %}
        {# Pas de checklist #}
        <div class="px-6 py-4 border-b-2 border-ink/10">
            <h2 class="font-bold text-ink flex items-center gap-2">
                <i data-feather="check-square" class="w-4 h-4"></i>
                Checklist
            </h2>
        </div>
        <div class="p-6 text-center text-muted">
            <i data-feather="clipboard" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">Aucune checklist associee a cette operation</p>
            {% if campagne.hasChecklistStructure is defined and campagne.hasChecklistStructure %}
                <p class="text-xs mt-1">La checklist sera appliquee au demarrage.</p>
            {% elseif campagne.checklistTemplate %}
                <p class="text-xs mt-1">Le template "{{ campagne.checklistTemplate.nom }}" sera applique au demarrage.</p>
            {% endif %}
        </div>
    {% endif %}
</turbo-frame>
