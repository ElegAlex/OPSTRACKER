{% extends 'campagne/_layout.html.twig' %}

{% block title %}Segments - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white border-b-4 border-ink">
    <div class="px-10 py-6 flex justify-between items-start">
        <div>
            {# Breadcrumb #}
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <a href="{{ path('app_campagne_index') }}" class="hover:text-ink">Campagnes</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-ink font-medium">{{ campagne.nom }}</span>
            </div>

            {# Title + Status #}
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold tracking-tight">Segments</h1>
                <span class="px-3 py-1 bg-{{ campagne.statutCouleur }} text-white text-[10px] font-bold uppercase tracking-wider">{{ campagne.statutLabel }}</span>
            </div>

            {# Meta #}
            <div class="flex items-center gap-6 mt-3 text-sm text-muted">
                <span class="flex items-center gap-2">
                    <i data-feather="grid" class="w-4 h-4"></i>
                    {{ segments|length }} segment{{ segments|length > 1 ? 's' : '' }}
                </span>
            </div>
        </div>

        {# Actions #}
        <div class="flex items-center gap-3">
            <a href="{{ path('app_segment_new', {campagne: campagne.id}) }}" class="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Nouveau segment
            </a>
        </div>
    </div>

    {# Onglets navigation campagne #}
    {% include 'campagne/_tabs.html.twig' with {campagne: campagne, active: 'segments'} only %}
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="px-10 py-8">

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : 'danger' }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : 'alert-circle' }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : 'danger' }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        {# ========================================
           PROGRESSION PAR SEGMENT (US-906)
           ======================================== #}
        <div class="bg-white border-2 border-ink mb-8">
            <div class="p-6 border-b-2 border-ink/10">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-primary"></div>
                    <h2 class="text-lg font-bold">Progression par segment</h2>
                </div>
            </div>

            <div class="divide-y divide-ink/5">
                {% for segment in segments %}
                {% set stat = statistiques[segment.id] is defined ? statistiques[segment.id] : null %}
                <a href="{{ path('app_segment_show', {campagne: campagne.id, id: segment.id}) }}"
                   class="block p-5 hover:bg-paper/50 transition-colors {{ stat and stat.en_retard ? 'bg-danger/5' : '' }}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-{{ segment.couleur }}"></div>
                            <h3 class="font-semibold text-ink">{{ segment.nom }}</h3>
                            <span class="text-xs text-muted">{{ stat ? stat.total : 0 }} operations</span>
                            {% if stat and stat.en_retard %}
                            <span class="flex items-center gap-1 px-2 py-0.5 bg-danger text-white text-[10px] font-bold uppercase">
                                <i data-feather="alert-triangle" class="w-3 h-3"></i>
                                En retard
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-2xl font-bold num {{ stat and stat.en_retard ? 'text-danger' : 'text-ink' }}">{{ stat ? stat.progression|round : 0 }}%</span>
                            <i data-feather="chevron-right" class="w-5 h-5 text-muted"></i>
                        </div>
                    </div>
                    <div class="h-3 bg-paper flex overflow-hidden">
                        {% if stat %}
                        <div class="bg-success h-full" style="width: {{ stat.total > 0 ? (stat.par_statut.realise|default(0) / stat.total * 100) : 0 }}%"></div>
                        <div class="bg-primary h-full" style="width: {{ stat.total > 0 ? ((stat.par_statut.planifie|default(0) + stat.par_statut.en_cours|default(0)) / stat.total * 100) : 0 }}%"></div>
                        <div class="bg-warning h-full" style="width: {{ stat.total > 0 ? (stat.par_statut.reporte|default(0) / stat.total * 100) : 0 }}%"></div>
                        <div class="bg-danger h-full" style="width: {{ stat.total > 0 ? (stat.par_statut.a_remedier|default(0) / stat.total * 100) : 0 }}%"></div>
                        {% endif %}
                    </div>
                    {% if stat and stat.total > 0 %}
                    <div class="flex items-center gap-6 mt-2 text-xs text-muted">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-success"></span> {{ stat.par_statut.realise|default(0) }} realises</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-primary"></span> {{ stat.par_statut.planifie|default(0) + stat.par_statut.en_cours|default(0) }} en cours</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-warning"></span> {{ stat.par_statut.reporte|default(0) }} reportes</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-danger"></span> {{ stat.par_statut.a_remedier|default(0) }} a remedier</span>
                    </div>
                    {% endif %}
                </a>
                {% endfor %}

                {# Sans segment #}
                {% if sans_segment.total > 0 %}
                <div class="p-5 bg-paper/30">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-muted border border-ink/20"></div>
                            <h3 class="font-semibold text-muted">Sans segment</h3>
                            <span class="text-xs text-muted">{{ sans_segment.total }} operations</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-2xl font-bold num text-muted">{{ sans_segment.progression|round }}%</span>
                        </div>
                    </div>
                    <div class="h-3 bg-white border border-ink/10 flex overflow-hidden">
                        <div class="bg-success h-full" style="width: {{ sans_segment.total > 0 ? (sans_segment.par_statut.realise|default(0) / sans_segment.total * 100) : 0 }}%"></div>
                        <div class="bg-primary h-full" style="width: {{ sans_segment.total > 0 ? ((sans_segment.par_statut.planifie|default(0) + sans_segment.par_statut.en_cours|default(0)) / sans_segment.total * 100) : 0 }}%"></div>
                        <div class="bg-warning h-full" style="width: {{ sans_segment.total > 0 ? (sans_segment.par_statut.reporte|default(0) / sans_segment.total * 100) : 0 }}%"></div>
                        <div class="bg-danger h-full" style="width: {{ sans_segment.total > 0 ? (sans_segment.par_statut.a_remedier|default(0) / sans_segment.total * 100) : 0 }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {# ========================================
           LISTE SEGMENTS CRUD
           ======================================== #}
        <h2 class="text-lg font-bold mb-4">Gestion des segments</h2>

        {% if segments|length > 0 %}
        <div class="bg-white border-2 border-ink overflow-hidden">
            <table class="w-full">
                <thead class="bg-paper border-b-2 border-ink">
                    <tr>
                        <th class="text-left px-6 py-4 text-xs font-bold text-ink uppercase tracking-wider">Couleur</th>
                        <th class="text-left px-6 py-4 text-xs font-bold text-ink uppercase tracking-wider">Nom</th>
                        <th class="text-left px-6 py-4 text-xs font-bold text-ink uppercase tracking-wider">Operations</th>
                        <th class="text-left px-6 py-4 text-xs font-bold text-ink uppercase tracking-wider">Progression</th>
                        <th class="px-6 py-4"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-ink/10">
                    {% for segment in segments %}
                    {% set stat = statistiques[segment.id] is defined ? statistiques[segment.id] : null %}
                    <tr class="hover:bg-paper/50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="w-6 h-6 bg-{{ segment.couleur }}"></div>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-ink">{{ segment.nom }}</td>
                        <td class="px-6 py-4 text-sm text-muted">{{ stat ? stat.total : 0 }}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-paper">
                                    <div class="h-full bg-success" style="width: {{ stat ? stat.progression : 0 }}%"></div>
                                </div>
                                <span class="text-sm font-medium num">{{ stat ? stat.progression|round : 0 }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a href="{{ path('app_segment_show', {campagne: campagne.id, id: segment.id}) }}"
                                   class="w-8 h-8 border border-ink/10 inline-flex items-center justify-center text-muted hover:bg-primary hover:text-white hover:border-primary transition-colors"
                                   title="Voir">
                                    <i data-feather="eye" class="w-4 h-4"></i>
                                </a>
                                <a href="{{ path('app_segment_edit', {campagne: campagne.id, id: segment.id}) }}"
                                   class="w-8 h-8 border border-ink/10 inline-flex items-center justify-center text-muted hover:bg-ink hover:text-white hover:border-ink transition-colors"
                                   title="Modifier">
                                    <i data-feather="edit-2" class="w-4 h-4"></i>
                                </a>
                                <form action="{{ path('app_segment_delete', {campagne: campagne.id, id: segment.id}) }}"
                                      method="post"
                                      class="inline"
                                      onsubmit="return confirm('Supprimer ce segment ? Les operations seront conservees sans segment.');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_segment_' ~ segment.id) }}">
                                    <button type="submit"
                                            class="w-8 h-8 border border-ink/10 inline-flex items-center justify-center text-muted hover:bg-danger hover:text-white hover:border-danger transition-colors"
                                            title="Supprimer">
                                        <i data-feather="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-white border-2 border-ink/20 border-dashed p-12 text-center">
            <div class="w-16 h-16 mx-auto bg-primary/10 flex items-center justify-center mb-4">
                <i data-feather="grid" class="w-8 h-8 text-primary"></i>
            </div>
            <h3 class="text-lg font-bold text-ink mb-2">Aucun segment</h3>
            <p class="text-sm text-muted mb-6">Les segments permettent de regrouper vos operations (par batiment, service, etc.)</p>
            <a href="{{ path('app_segment_new', {campagne: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="plus" class="w-4 h-4"></i>
                Creer un segment
            </a>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
