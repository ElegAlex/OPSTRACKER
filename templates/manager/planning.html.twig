{% extends 'campagne/_layout.html.twig' %}

{% block title %}Planning equipe - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white px-12 py-8 border-b-4 border-ink">
    <div class="flex justify-between items-start">
        <div>
            {# Breadcrumb #}
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <a href="{{ path('app_campagne_index') }}" class="hover:text-ink">Campagnes</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <a href="{{ path('app_dashboard_campagne', {id: campagne.id}) }}" class="hover:text-ink">{{ campagne.nom }}</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-ink font-medium">Planning equipe</span>
            </div>

            {# Title #}
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold tracking-tight">Planning de mon equipe</h1>
                <span class="px-2 py-1 bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider">
                    RG-127
                </span>
            </div>

            {# Meta #}
            <div class="flex items-center gap-6 mt-3 text-sm text-muted">
                <span class="flex items-center gap-2">
                    <i data-feather="users" class="w-4 h-4"></i>
                    {{ total_agents }} agent{{ total_agents > 1 ? 's' : '' }} dans l'equipe
                </span>
                <span class="flex items-center gap-2">
                    <i data-feather="check-circle" class="w-4 h-4 text-success"></i>
                    {{ total_positionnes }} positionne{{ total_positionnes > 1 ? 's' : '' }}
                </span>
                {% if jours_avec_alerte > 0 %}
                <span class="flex items-center gap-2 text-warning">
                    <i data-feather="alert-triangle" class="w-4 h-4"></i>
                    {{ jours_avec_alerte }} jour{{ jours_avec_alerte > 1 ? 's' : '' }} avec alerte
                </span>
                {% endif %}
            </div>
        </div>

        {# Actions - Navigation entre vues #}
        <div class="flex items-center gap-3">
            <a href="{{ path('app_manager_agents', {campagne: campagne.id}) }}"
               class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors">
                <i data-feather="list" class="w-4 h-4"></i>
                Vue liste
            </a>
            <span class="flex items-center gap-2 px-4 py-2 text-sm font-medium bg-ink text-white">
                <i data-feather="bar-chart-2" class="w-4 h-4"></i>
                Vue planning
            </span>
            <a href="{{ path('app_manager_calendar', {campagne: campagne.id}) }}"
               class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors">
                <i data-feather="calendar" class="w-4 h-4"></i>
                Calendrier
            </a>
        </div>
    </div>
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="px-12 py-8">

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'info' ? 'primary' : 'danger')) }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : (label == 'warning' ? 'alert-triangle' : (label == 'info' ? 'info' : 'alert-circle')) }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'info' ? 'primary' : 'danger')) }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        {# Legende alerte RG-127 #}
        <div class="bg-warning/5 border-2 border-warning/20 p-4 mb-8">
            <div class="flex items-center gap-3">
                <i data-feather="alert-triangle" class="w-5 h-5 text-warning"></i>
                <div>
                    <p class="font-semibold text-ink">Regle RG-127 : Alerte concentration equipe</p>
                    <p class="text-sm text-muted">Une alerte s'affiche lorsque plus de 50% de votre equipe est positionnee le meme jour.</p>
                </div>
            </div>
        </div>

        {# Planning par date #}
        {% if planning|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for dateKey, data in planning %}
            <div class="bg-white border-2 {{ data.alerte ? 'border-warning' : 'border-ink' }} {{ data.alerte ? 'alerte-concentration' : '' }}">
                {# Header date #}
                <div class="px-6 py-4 border-b-2 {{ data.alerte ? 'border-warning bg-warning/10' : 'border-ink/10' }}">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold text-muted uppercase tracking-wider">{{ data.date|date('l') }}</p>
                            <p class="text-xl font-bold text-ink">{{ data.date|date('d/m/Y') }}</p>
                        </div>
                        {% if data.alerte %}
                        <span class="px-2 py-1 bg-warning text-white text-xs font-bold uppercase flex items-center gap-1">
                            <i data-feather="alert-triangle" class="w-3 h-3"></i>
                            >50%
                        </span>
                        {% endif %}
                    </div>
                </div>

                {# Stats jour #}
                <div class="px-6 py-4 border-b border-ink/10">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-muted">Agents positionnes</span>
                        <span class="text-lg font-bold {{ data.alerte ? 'text-warning' : 'text-ink' }}">
                            {{ data.count }} / {{ total_agents }}
                        </span>
                    </div>
                    <div class="h-2 bg-paper">
                        <div class="h-full {{ data.alerte ? 'bg-warning' : 'bg-success' }}" style="width: {{ data.taux }}%"></div>
                    </div>
                    <p class="text-right text-xs text-muted mt-1">{{ data.taux }}%</p>
                </div>

                {# Liste agents #}
                <div class="px-6 py-4">
                    <p class="text-xs font-semibold text-muted uppercase tracking-wider mb-3">Agents ce jour</p>
                    <div class="space-y-2">
                        {% for agent in data.agents %}
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-primary/10 flex items-center justify-center text-xs font-semibold text-primary">
                                {{ agent.prenom|first|upper }}{{ agent.nom|first|upper }}
                            </div>
                            <span class="text-sm text-ink truncate">{{ agent.nomComplet }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white border-2 border-ink/20 border-dashed p-12 text-center">
            <div class="w-16 h-16 mx-auto bg-primary/10 flex items-center justify-center mb-4">
                <i data-feather="calendar" class="w-8 h-8 text-primary"></i>
            </div>
            <h3 class="text-lg font-bold text-ink mb-2">Aucune reservation</h3>
            <p class="text-sm text-muted mb-6">Aucun agent de votre equipe n'est encore positionne pour cette campagne.</p>
            <a href="{{ path('app_manager_agents', {campagne: campagne.id}) }}" class="inline-flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="users" class="w-4 h-4"></i>
                Voir mes agents
            </a>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
