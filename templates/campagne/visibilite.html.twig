{% extends 'campagne/_layout.html.twig' %}

{% block title %}Visibilite - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white px-12 py-10 border-b-4 border-ink">
    <div class="flex justify-between items-start">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-3 h-3 bg-{{ campagne.statutCouleur }}"></div>
                <span class="text-xs font-semibold text-muted uppercase tracking-[0.15em]">Campagne</span>
            </div>
            <h1 class="text-4xl font-bold tracking-tight">Partage & Visibilite</h1>
            <p class="text-sm text-muted mt-2">{{ campagne.nom }}</p>
        </div>
        <a href="{{ path('app_campagne_show', {id: campagne.id}) }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted hover:text-ink transition-colors">
            <i data-feather="arrow-left" class="w-4 h-4"></i>
            Retour
        </a>
    </div>
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="px-12 py-10">

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : 'danger' }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : 'alert-circle' }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : 'danger' }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        <div class="max-w-2xl">
            {# Info visibilite actuelle #}
            <div class="bg-white border-2 border-ink p-6 mb-8">
                <h3 class="text-sm font-bold text-muted uppercase tracking-wider mb-4">Visibilite actuelle</h3>
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-{{ campagne.publique ? 'success' : 'primary' }}/10 flex items-center justify-center">
                        <i data-feather="{{ campagne.publique ? 'globe' : 'lock' }}" class="w-6 h-6 text-{{ campagne.publique ? 'success' : 'primary' }}"></i>
                    </div>
                    <div>
                        <p class="font-bold text-ink">{{ campagne.visibiliteLabel }}</p>
                        <p class="text-sm text-muted">
                            {% if campagne.publique %}
                                Tous les utilisateurs peuvent voir cette campagne
                            {% else %}
                                {{ campagne.utilisateursHabilites|length }} utilisateur{{ campagne.utilisateursHabilites|length > 1 ? 's' : '' }} habilite{{ campagne.utilisateursHabilites|length > 1 ? 's' : '' }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            {# Formulaire #}
            <div class="bg-white border-2 border-ink p-6">
                <h3 class="text-sm font-bold text-muted uppercase tracking-wider mb-6">Configuration</h3>

                {{ form_start(form, {attr: {class: 'space-y-8'}}) }}

                {# Mode de visibilite #}
                <div>
                    <label class="block text-sm font-medium text-ink mb-4">{{ form_label(form.visibilite) }}</label>
                    <div class="space-y-3">
                        {% for choice in form.visibilite %}
                        <label class="flex items-start gap-4 p-4 border-2 border-ink/10 hover:border-ink/30 cursor-pointer transition-colors">
                            {{ form_widget(choice, {attr: {class: 'mt-1'}}) }}
                            <div>
                                <span class="font-medium text-ink">{{ choice.vars.label }}</span>
                                {% if choice.vars.value == 'publique' %}
                                <p class="text-sm text-muted mt-1">Tous les utilisateurs de l'application pourront voir cette campagne</p>
                                {% else %}
                                <p class="text-sm text-muted mt-1">Seuls le proprietaire et les utilisateurs habilites pourront voir cette campagne</p>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                {# Utilisateurs habilites #}
                <div id="utilisateurs-habilites-section">
                    {{ form_label(form.utilisateursHabilites, null, {label_attr: {class: 'block text-sm font-medium text-ink mb-2'}}) }}
                    {{ form_widget(form.utilisateursHabilites) }}
                    <p class="text-xs text-muted mt-2">{{ form_help(form.utilisateursHabilites) }}</p>
                    {{ form_errors(form.utilisateursHabilites) }}
                </div>

                <div class="flex items-center gap-4 pt-4 border-t border-ink/10">
                    <button type="submit" class="flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                        <i data-feather="save" class="w-4 h-4"></i>
                        Enregistrer
                    </button>
                    <a href="{{ path('app_campagne_show', {id: campagne.id}) }}" class="px-6 py-3 text-sm font-medium text-muted hover:text-ink transition-colors">
                        Annuler
                    </a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

<script>
    // Afficher/masquer la section utilisateurs habilites selon le mode
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('[name="visibilite_campagne[visibilite]"]');
        const section = document.getElementById('utilisateurs-habilites-section');

        function updateVisibility() {
            const selected = document.querySelector('[name="visibilite_campagne[visibilite]"]:checked');
            if (selected && selected.value === 'publique') {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        }

        radios.forEach(radio => radio.addEventListener('change', updateVisibility));
        updateVisibility();
    });
</script>
{% endblock %}
