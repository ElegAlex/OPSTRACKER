{% extends 'campagne/_layout.html.twig' %}

{% block title %}Import - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block main %}
{# HEADER #}
<header class="bg-white px-12 py-10 border-b-4 border-ink">
    <div class="flex justify-between items-end">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-3 h-3 bg-primary"></div>
                <span class="text-xs font-semibold text-muted uppercase tracking-[0.15em]">Etape {{ step }}/4</span>
            </div>
            <h1 class="text-4xl font-bold tracking-tight">{{ campagne.nom }}</h1>
            <p class="text-muted mt-2">Confirmation de l'import</p>
        </div>
        <a href="{{ path('app_campagne_index') }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted hover:text-ink transition-colors">
            <i data-feather="arrow-left" class="w-4 h-4"></i>
            Retour aux campagnes
        </a>
    </div>
</header>

{# CONTENT #}
<div class="flex-1 overflow-auto">
    <div class="max-w-4xl mx-auto px-12 py-10">

        {# Progress steps #}
        <div class="flex items-center gap-4 mb-12">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-success text-white flex items-center justify-center">
                    <i data-feather="check" class="w-5 h-5"></i>
                </div>
                <span class="text-sm font-medium text-success">Infos</span>
            </div>
            <div class="flex-1 h-0.5 bg-success"></div>
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-success text-white flex items-center justify-center">
                    <i data-feather="check" class="w-5 h-5"></i>
                </div>
                <span class="text-sm font-medium text-success">Import</span>
            </div>
            <div class="flex-1 h-0.5 bg-success"></div>
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary text-white flex items-center justify-center font-bold">3</div>
                <span class="text-sm font-medium text-ink">Confirmer</span>
            </div>
            <div class="flex-1 h-0.5 bg-ink/10"></div>
            <div class="flex items-center gap-3 opacity-50">
                <div class="w-10 h-10 border-2 border-ink/20 flex items-center justify-center font-bold text-muted">4</div>
                <span class="text-sm font-medium text-muted">Config</span>
            </div>
        </div>

        {# File info #}
        <div class="bg-paper border-2 border-ink/10 p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 flex items-center justify-center">
                        <i data-feather="file-text" class="w-6 h-6 text-success"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-ink">Fichier CSV analyse</h3>
                        <p class="text-sm text-muted">
                            {{ analysis.total_lines }} ligne(s) detectee(s) |
                            Encodage : {{ analysis.encoding }} |
                            Separateur : {% if analysis.separator == ';' %}point-virgule{% elseif analysis.separator == ',' %}virgule{% elseif analysis.separator == "\t" %}tabulation{% else %}{{ analysis.separator }}{% endif %}
                        </p>
                    </div>
                </div>
                <span class="px-3 py-1 text-xs font-semibold bg-success/10 text-success">
                    {{ headers|length }} colonnes
                </span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-8">
            {# Colonnes a creer #}
            <div class="bg-white border-2 border-ink p-8">
                <h2 class="text-lg font-bold text-ink mb-2">Colonnes a creer</h2>
                <p class="text-sm text-muted mb-6">Ces colonnes seront ajoutees a votre campagne.</p>

                <div class="flex flex-wrap gap-2 mb-6">
                    {% for header in headers %}
                        <span class="px-3 py-1.5 bg-primary/10 text-primary text-sm font-medium border border-primary/20">
                            {{ header }}
                        </span>
                    {% endfor %}
                </div>

                <div class="bg-success/5 border border-success/20 p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <i data-feather="check-circle" class="w-5 h-5 text-success mt-0.5"></i>
                        <div>
                            <span class="font-medium text-ink">Import automatique</span>
                            <p class="text-sm text-muted mt-1">
                                <strong>{{ headers|length }}</strong> colonnes seront creees et
                                <strong>{{ analysis.total_lines }}</strong> operations importees.
                            </p>
                        </div>
                    </div>
                </div>

                {{ form_start(form, {'attr': {'class': ''}}) }}
                    {{ form_widget(form.csv_encoding) }}
                    {{ form_widget(form.csv_separator) }}

                    {# Mapping colonnes DATE / HORAIRE #}
                    <div class="bg-primary/5 border border-primary/20 p-4 mb-6">
                        <h4 class="font-semibold text-ink mb-3 flex items-center gap-2">
                            <i data-feather="calendar" class="w-4 h-4 text-primary"></i>
                            Mapping des dates de planification
                        </h4>
                        <p class="text-xs text-muted mb-4">
                            Selectionnez les colonnes contenant la date et l'heure pour remplir automatiquement la date de planification des operations.
                        </p>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-ink mb-1">Colonne DATE</label>
                                <select name="colonne_date_planifiee" class="w-full px-3 py-2 text-sm border-2 border-ink/20 bg-white focus:border-primary focus:outline-none">
                                    <option value="">-- Aucune --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}" {% if header|lower in ['date', 'date_planifiee', 'jour', 'day'] %}selected{% endif %}>{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-ink mb-1">Colonne HORAIRE (optionnel)</label>
                                <select name="colonne_horaire" class="w-full px-3 py-2 text-sm border-2 border-ink/20 bg-white focus:border-primary focus:outline-none">
                                    <option value="">-- Inclus dans la date --</option>
                                    {% for header in headers %}
                                    <option value="{{ header }}" {% if header|lower in ['horaire', 'heure', 'time', 'hour'] %}selected{% endif %}>{{ header }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    {# Mapping colonne SEGMENT #}
                    <div class="bg-success/5 border border-success/20 p-4 mb-6">
                        <h4 class="font-semibold text-ink mb-3 flex items-center gap-2">
                            <i data-feather="grid" class="w-4 h-4 text-success"></i>
                            Mapping des segments
                        </h4>
                        <p class="text-xs text-muted mb-4">
                            Selectionnez la colonne pour regrouper les operations par segment (ex: Site, Service, Batiment...).
                        </p>

                        <div>
                            <label class="block text-xs font-semibold text-ink mb-1">Colonne SEGMENT (optionnel)</label>
                            <select name="colonne_segment" class="w-full px-3 py-2 text-sm border-2 border-ink/20 bg-white focus:border-success focus:outline-none">
                                <option value="">-- Pas de segmentation --</option>
                                {% for header in headers %}
                                <option value="{{ header }}" {% if header|lower in ['segment', 'site', 'service', 'batiment', 'building', 'departement', 'zone'] %}selected{% endif %}>{{ header }}</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-muted mt-1">Les segments seront crees automatiquement a partir des valeurs uniques de cette colonne.</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center gap-4 pt-6 border-t-2 border-ink/10">
                        <a href="{{ path('app_campagne_step2', {id: campagne.id}) }}" class="flex items-center gap-2 px-6 py-3 text-sm font-semibold text-muted hover:text-ink transition-colors">
                            <i data-feather="arrow-left" class="w-4 h-4"></i>
                            Retour
                        </a>
                        <button type="submit" class="flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                            Confirmer l'import
                            <i data-feather="check" class="w-4 h-4"></i>
                        </button>
                    </div>
                {{ form_end(form) }}
            </div>

            {# Preview #}
            <div class="bg-white border-2 border-ink/10 p-8">
                <h2 class="text-lg font-bold text-ink mb-2">Apercu des donnees</h2>
                <p class="text-sm text-muted mb-6">Premieres lignes de votre fichier CSV.</p>

                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-paper">
                                {% for header in headers %}
                                <th class="px-3 py-2 text-left font-semibold text-ink border-b-2 border-ink/10 whitespace-nowrap">
                                    {{ header }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in analysis.preview %}
                            <tr class="{% if loop.index is odd %}bg-paper/50{% endif %}">
                                {% for value in row %}
                                <td class="px-3 py-2 text-muted border-b border-ink/5 whitespace-nowrap max-w-[150px] truncate" title="{{ value }}">
                                    {{ value|default('-')|slice(0, 30) }}{% if value|default('')|length > 30 %}...{% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if analysis.total_lines > 5 %}
                <p class="text-xs text-muted mt-4 text-center">
                    ... et {{ analysis.total_lines - 5 }} autres ligne(s)
                </p>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endblock %}
