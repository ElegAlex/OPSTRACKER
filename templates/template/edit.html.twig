{% extends 'base.html.twig' %}

{% block title %}Modifier {{ template.nom }} - OpsTracker{% endblock %}

{% block body %}
<div class="min-h-screen bg-paper">
    {# HEADER #}
    <header class="bg-white px-12 py-10 border-b-4 border-ink">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-3 h-3 bg-primary"></div>
                    <span class="text-xs font-semibold text-muted uppercase tracking-[0.15em]">Modifier template</span>
                </div>
                <h1 class="text-4xl font-bold tracking-tight">{{ template.nom }}</h1>
                <span class="inline-block mt-2 px-3 py-1 bg-ink/10 text-ink text-sm font-bold">v{{ template.version }}</span>
            </div>
            <a href="{{ path('app_template_show', {id: template.id}) }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted hover:text-ink transition-colors">
                <i data-feather="arrow-left" class="w-4 h-4"></i>
                Retour
            </a>
        </div>
    </header>

    {# CONTENT #}
    <div class="px-12 py-10">
        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 p-4 border-2 border-ink/20 bg-{{ label == 'success' ? 'success' : 'danger' }}/10 flex items-center gap-3">
                    <i data-feather="{{ label == 'success' ? 'check-circle' : 'alert-circle' }}" class="w-5 h-5 text-{{ label == 'success' ? 'success' : 'danger' }}"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
            {% endfor %}
        {% endfor %}

        {# RG-031 : Avertissement si des instances existent #}
        {% if will_create_new_version %}
        <div class="mb-6 p-4 border-2 border-warning bg-warning/10 flex items-start gap-3">
            <i data-feather="alert-triangle" class="w-5 h-5 text-warning flex-shrink-0 mt-0.5"></i>
            <div>
                <p class="text-sm font-bold text-warning">Attention : Nouvelle version</p>
                <p class="text-sm text-muted mt-1">
                    Ce template est utilise par <strong>{{ instances_count }} checklist{{ instances_count > 1 ? 's' : '' }}</strong> en cours.
                    La modification creera la <strong>v{{ template.version + 1 }}</strong>.
                    Les checklists existantes conserveront leur structure actuelle (v{{ template.version }}).
                </p>
            </div>
        </div>
        {% endif %}

        <form method="POST" action="{{ path('app_template_edit', {id: template.id}) }}" id="templateForm">
            <div class="space-y-8">
                {# Informations generales #}
                <div class="bg-white border-2 border-ink p-6">
                    <h3 class="text-sm font-bold text-muted uppercase tracking-wider mb-6">Informations generales</h3>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label for="nom" class="block text-sm font-medium text-ink mb-2">Nom du template *</label>
                            <input type="text" id="nom" name="nom" value="{{ template.nom }}" required
                                   class="w-full px-4 py-3 border-2 border-ink/20 focus:border-ink outline-none">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-ink mb-2">Description</label>
                            <textarea id="description" name="description" rows="1"
                                      class="w-full px-4 py-3 border-2 border-ink/20 focus:border-ink outline-none">{{ template.description }}</textarea>
                        </div>
                    </div>
                </div>

                {# Phases et etapes #}
                <div class="bg-white border-2 border-ink">
                    <div class="px-6 py-4 border-b-2 border-ink bg-paper flex items-center justify-between">
                        <h3 class="font-bold text-ink">Phases et etapes</h3>
                        <button type="button" onclick="addPhase()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium border-2 border-ink hover:bg-ink hover:text-white transition-colors">
                            <i data-feather="plus" class="w-4 h-4"></i>
                            Ajouter une phase
                        </button>
                    </div>

                    <div id="phasesContainer">
                        {% for phase in template.phases %}
                        <div class="phase-block border-b border-ink/10 last:border-b-0" data-phase-index="{{ loop.index0 }}">
                            <div class="px-6 py-4 bg-ink/5 flex items-center gap-4">
                                <span class="drag-handle cursor-move text-muted"><i data-feather="grip-vertical" class="w-4 h-4"></i></span>
                                <input type="text" name="phases[{{ loop.index0 }}][nom]" value="{{ phase.nom }}"
                                       class="flex-1 px-3 py-2 border-2 border-ink/10 focus:border-ink outline-none font-bold"
                                       placeholder="Nom de la phase">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="phases[{{ loop.index0 }}][verrouillable]" {{ phase.verrouillable ? 'checked' : '' }}
                                           class="w-4 h-4">
                                    <span class="text-muted">Verrouillable (RG-032)</span>
                                </label>
                                <button type="button" onclick="removePhase(this)" class="w-8 h-8 border border-danger/30 flex items-center justify-center text-danger hover:bg-danger hover:text-white transition-colors">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="etapes-container px-6 py-4 space-y-2">
                                {% for etape in phase.etapes %}
                                <div class="etape-row flex items-center gap-3 p-3 bg-paper/50 border border-ink/10">
                                    <span class="drag-handle cursor-move text-muted"><i data-feather="grip-vertical" class="w-3 h-3"></i></span>
                                    <input type="text" name="phases[{{ loop.parent.loop.index0 }}][etapes][{{ loop.index0 }}][titre]"
                                           value="{{ etape.titre }}" placeholder="Titre de l'etape *"
                                           class="flex-1 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
                                    <input type="text" name="phases[{{ loop.parent.loop.index0 }}][etapes][{{ loop.index0 }}][description]"
                                           value="{{ etape.description }}" placeholder="Description (optionnel)"
                                           class="flex-1 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
                                    <input type="number" name="phases[{{ loop.parent.loop.index0 }}][etapes][{{ loop.index0 }}][documentId]"
                                           value="{{ etape.documentId }}" placeholder="ID Doc"
                                           class="w-20 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
                                    <label class="flex items-center gap-1 text-xs">
                                        <input type="checkbox" name="phases[{{ loop.parent.loop.index0 }}][etapes][{{ loop.index0 }}][obligatoire]"
                                               {{ etape.obligatoire ? 'checked' : '' }} class="w-3 h-3">
                                        <span class="text-muted">Oblig.</span>
                                    </label>
                                    <button type="button" onclick="removeEtape(this)" class="w-6 h-6 text-danger hover:bg-danger/10 transition-colors">
                                        <i data-feather="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="px-6 pb-4">
                                <button type="button" onclick="addEtape(this)" class="flex items-center gap-2 px-3 py-1 text-xs font-medium text-primary hover:bg-primary/10 transition-colors">
                                    <i data-feather="plus" class="w-3 h-3"></i>
                                    Ajouter une etape
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="px-6 py-8 text-center text-muted" id="emptyPhasesMessage">
                            <p>Aucune phase. Cliquez sur "Ajouter une phase" pour commencer.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {# Boutons d'action #}
                <div class="flex items-center gap-4">
                    <button type="submit" class="flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                        <i data-feather="save" class="w-4 h-4"></i>
                        {% if will_create_new_version %}
                        Enregistrer (creer v{{ template.version + 1 }})
                        {% else %}
                        Enregistrer
                        {% endif %}
                    </button>
                    <a href="{{ path('app_template_show', {id: template.id}) }}" class="px-6 py-3 text-sm font-medium text-muted hover:text-ink transition-colors">
                        Annuler
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let phaseCounter = {{ template.phases|length }};

function addPhase() {
    const container = document.getElementById('phasesContainer');
    const emptyMessage = document.getElementById('emptyPhasesMessage');
    if (emptyMessage) emptyMessage.remove();

    const phaseIndex = phaseCounter++;
    const phaseHtml = `
        <div class="phase-block border-b border-ink/10" data-phase-index="${phaseIndex}">
            <div class="px-6 py-4 bg-ink/5 flex items-center gap-4">
                <span class="drag-handle cursor-move text-muted"><i data-feather="grip-vertical" class="w-4 h-4"></i></span>
                <input type="text" name="phases[${phaseIndex}][nom]" value="Phase ${phaseIndex + 1}"
                       class="flex-1 px-3 py-2 border-2 border-ink/10 focus:border-ink outline-none font-bold"
                       placeholder="Nom de la phase">
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" name="phases[${phaseIndex}][verrouillable]" class="w-4 h-4">
                    <span class="text-muted">Verrouillable (RG-032)</span>
                </label>
                <button type="button" onclick="removePhase(this)" class="w-8 h-8 border border-danger/30 flex items-center justify-center text-danger hover:bg-danger hover:text-white transition-colors">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="etapes-container px-6 py-4 space-y-2"></div>
            <div class="px-6 pb-4">
                <button type="button" onclick="addEtape(this)" class="flex items-center gap-2 px-3 py-1 text-xs font-medium text-primary hover:bg-primary/10 transition-colors">
                    <i data-feather="plus" class="w-3 h-3"></i>
                    Ajouter une etape
                </button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', phaseHtml);
    feather.replace();
}

function removePhase(button) {
    if (confirm('Supprimer cette phase et toutes ses etapes ?')) {
        button.closest('.phase-block').remove();
    }
}

function addEtape(button) {
    const phaseBlock = button.closest('.phase-block');
    const phaseIndex = phaseBlock.dataset.phaseIndex;
    const container = phaseBlock.querySelector('.etapes-container');
    const etapeIndex = container.querySelectorAll('.etape-row').length;

    const etapeHtml = `
        <div class="etape-row flex items-center gap-3 p-3 bg-paper/50 border border-ink/10">
            <span class="drag-handle cursor-move text-muted"><i data-feather="grip-vertical" class="w-3 h-3"></i></span>
            <input type="text" name="phases[${phaseIndex}][etapes][${etapeIndex}][titre]"
                   placeholder="Titre de l'etape *"
                   class="flex-1 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
            <input type="text" name="phases[${phaseIndex}][etapes][${etapeIndex}][description]"
                   placeholder="Description (optionnel)"
                   class="flex-1 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
            <input type="number" name="phases[${phaseIndex}][etapes][${etapeIndex}][documentId]"
                   placeholder="ID Doc"
                   class="w-20 px-3 py-2 border border-ink/10 focus:border-ink outline-none text-sm">
            <label class="flex items-center gap-1 text-xs">
                <input type="checkbox" name="phases[${phaseIndex}][etapes][${etapeIndex}][obligatoire]" checked class="w-3 h-3">
                <span class="text-muted">Oblig.</span>
            </label>
            <button type="button" onclick="removeEtape(this)" class="w-6 h-6 text-danger hover:bg-danger/10 transition-colors">
                <i data-feather="x" class="w-4 h-4"></i>
            </button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', etapeHtml);
    feather.replace();
}

function removeEtape(button) {
    button.closest('.etape-row').remove();
}
</script>
{% endblock %}
