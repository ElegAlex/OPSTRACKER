{% extends 'campagne/_layout.html.twig' %}

{% block title %}Dashboard Global - OpsTracker{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Cards */
    .card-elevated {
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
    }

    /* Live indicator pulse - RG-040 */
    @keyframes pulse-live {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .live-pulse {
        animation: pulse-live 2s ease-in-out infinite;
    }

    /* Campagne card hover */
    .campagne-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .campagne-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px -12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block main %}
{# ========================================
   HEADER
   ======================================== #}
<header class="bg-white border-b-4 border-ink">
    <div class="px-10 py-6 flex justify-between items-start">
        <div>
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <span class="text-ink font-medium">Dashboard Global</span>
            </div>
            <h1 class="text-3xl font-bold tracking-tight">Vue d'ensemble</h1>
            <p class="text-muted mt-2">Toutes les campagnes actives en un coup d'oeil</p>
        </div>

        <div class="flex items-center gap-3">
            <a href="{{ path('app_campagne_index') }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors">
                <i data-feather="layers" class="w-4 h-4"></i>
                Portfolio
            </a>
        </div>
    </div>
</header>

{# ========================================
   CONTENT
   ======================================== #}
<div class="flex-1 overflow-auto">
    <div class="px-10 py-8">

        {# Live indicator + Filtres (T-1307) #}
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-success rounded-full live-pulse"></div>
                <span class="text-xs font-medium text-muted uppercase tracking-wider">Donnees temps reel</span>
            </div>

            {# Filtres par statut - US-608, T-1307 #}
            <form action="{{ path('app_dashboard_global') }}" method="GET" class="flex items-center gap-4">
                <span class="text-sm font-medium text-muted">Filtrer par statut :</span>
                <div class="flex items-center gap-3">
                    {% for value, label in statutsDisponibles %}
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox"
                               name="statuts[]"
                               value="{{ value }}"
                               {{ value in filtresActifs ? 'checked' : '' }}
                               class="w-4 h-4 border-2 border-ink accent-primary"
                               onchange="this.form.submit()">
                        <span class="text-sm {% if value in filtresActifs %}font-semibold text-ink{% else %}text-muted{% endif %}">{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% if filtresActifs|length > 0 %}
                <a href="{{ path('app_dashboard_global') }}" class="text-sm text-primary hover:text-primary/80 font-medium">
                    Effacer les filtres
                </a>
                {% endif %}
            </form>
        </div>

        {# Indicateur de filtre actif #}
        {% if filtresActifs|length > 0 %}
        <div class="mb-6 px-4 py-3 bg-primary/5 border border-primary/20 flex items-center gap-3">
            <i data-feather="filter" class="w-4 h-4 text-primary"></i>
            <span class="text-sm">
                <strong>Filtre actif :</strong>
                {% for statut in filtresActifs %}
                    {{ statutsDisponibles[statut] ?? statut }}{{ not loop.last ? ', ' : '' }}
                {% endfor %}
                ({{ totaux.campagnes }} campagne{{ totaux.campagnes > 1 ? 's' : '' }})
            </span>
        </div>
        {% endif %}

        {# ========================================
           TOTAUX GLOBAUX (T-703)
           ======================================== #}
        <div class="grid grid-cols-5 gap-6 mb-10">
            {# Total campagnes #}
            <div class="card-elevated border-2 border-ink p-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-ink/5 flex items-center justify-center">
                        <i data-feather="layers" class="w-5 h-5 text-ink"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold num text-ink">{{ totaux.campagnes }}</p>
                <p class="text-sm font-medium text-muted uppercase tracking-wide">Campagnes actives</p>
            </div>

            {# Total operations #}
            <div class="card-elevated border-2 border-ink p-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-primary/10 flex items-center justify-center">
                        <i data-feather="target" class="w-5 h-5 text-primary"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold num text-ink">{{ totaux.operations }}</p>
                <p class="text-sm font-medium text-muted uppercase tracking-wide">Operations totales</p>
            </div>

            {# Realise #}
            <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-success"></div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-success/10 flex items-center justify-center">
                        <i data-feather="check-circle" class="w-5 h-5 text-success"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold num text-ink">{{ totaux.realise }}</p>
                <p class="text-sm font-medium text-muted uppercase tracking-wide">Realisees</p>
            </div>

            {# Progression globale #}
            <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-complete"></div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-complete/10 flex items-center justify-center">
                        <i data-feather="trending-up" class="w-5 h-5 text-complete"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold num text-ink">{{ totaux.progression }}%</p>
                <p class="text-sm font-medium text-muted uppercase tracking-wide">Progression</p>
            </div>

            {# A remedier #}
            <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-danger"></div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-danger/10 flex items-center justify-center">
                        <i data-feather="alert-triangle" class="w-5 h-5 text-danger"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold num text-ink">{{ totaux.a_remedier }}</p>
                <p class="text-sm font-medium text-muted uppercase tracking-wide">A remedier</p>
            </div>
        </div>

        {# ========================================
           LISTE DES CAMPAGNES ACTIVES
           ======================================== #}
        <div class="card-elevated border-2 border-ink">
            <div class="p-6 border-b-2 border-ink/10">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-primary"></div>
                    <h2 class="text-lg font-bold">Campagnes en cours</h2>
                </div>
            </div>

            {% if campagnes|length == 0 %}
            <div class="p-12 text-center text-muted">
                <i data-feather="layers" class="w-16 h-16 mx-auto mb-4 text-ink/10"></i>
                <p class="font-medium text-lg mb-2">Aucune campagne active</p>
                <p class="text-sm">Creez une nouvelle campagne pour commencer</p>
                <a href="{{ path('app_campagne_new') }}" class="inline-flex items-center gap-2 mt-6 px-6 py-3 bg-ink text-white font-semibold hover:bg-ink/90 transition-colors">
                    <i data-feather="plus" class="w-4 h-4"></i>
                    Nouvelle campagne
                </a>
            </div>
            {% else %}
            <div class="divide-y divide-ink/5">
                {% for item in campagnes %}
                {% set c = item.campagne %}
                {% set k = item.kpi %}
                <a href="{{ path('app_dashboard_campagne', {id: c.id}) }}" class="campagne-card block p-6 hover:bg-cream/50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="font-bold text-lg">{{ c.nom }}</h3>
                                <span class="px-2 py-0.5 bg-{{ c.statutCouleur }} text-white text-[10px] font-bold uppercase tracking-wider">
                                    {{ c.statutLabel }}
                                </span>
                            </div>
                            <div class="flex items-center gap-6 text-sm text-muted">
                                {% if c.typeOperation %}
                                <span class="flex items-center gap-1">
                                    <i data-feather="monitor" class="w-4 h-4"></i>
                                    {{ c.typeOperation.nom }}
                                </span>
                                {% endif %}
                                <span class="flex items-center gap-1">
                                    <i data-feather="calendar" class="w-4 h-4"></i>
                                    {{ c.dateDebut|date('d/m/Y') }} - {{ c.dateFin|date('d/m/Y') }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-feather="layers" class="w-4 h-4"></i>
                                    {{ item.segments_count }} segment{{ item.segments_count > 1 ? 's' : '' }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-feather="users" class="w-4 h-4"></i>
                                    {{ item.techniciens_count }} technicien{{ item.techniciens_count > 1 ? 's' : '' }}
                                </span>
                            </div>
                        </div>

                        {# KPIs mini #}
                        <div class="flex items-center gap-6">
                            <div class="text-right">
                                <p class="text-2xl font-bold num">{{ k.realise.count }}/{{ k.total }}</p>
                                <p class="text-xs text-muted">operations</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold num {{ k.realise.percentage >= 70 ? 'text-success' : (k.realise.percentage >= 40 ? 'text-warning' : 'text-danger') }}">
                                    {{ k.realise.percentage }}%
                                </p>
                                <p class="text-xs text-muted">progression</p>
                            </div>
                            <i data-feather="chevron-right" class="w-5 h-5 text-muted"></i>
                        </div>
                    </div>

                    {# Barre de progression globale #}
                    <div class="mt-4 h-2 bg-paper flex overflow-hidden">
                        <div class="bg-success h-full" style="width: {{ k.realise.percentage }}%"></div>
                        <div class="bg-primary h-full" style="width: {{ k.planifie.percentage }}%"></div>
                        <div class="bg-warning h-full" style="width: {{ k.reporte.percentage }}%"></div>
                        <div class="bg-danger h-full" style="width: {{ k.a_remedier.percentage }}%"></div>
                    </div>

                    {# Legende mini - RG-080 #}
                    <div class="flex items-center gap-4 mt-2 text-xs text-muted">
                        <span class="flex items-center gap-1">
                            <span class="w-2 h-2 bg-success"></span>
                            {{ k.realise.count }} realise{{ k.realise.count > 1 ? 's' : '' }}
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="w-2 h-2 bg-primary"></span>
                            {{ k.planifie.count }} planifie{{ k.planifie.count > 1 ? 's' : '' }}
                        </span>
                        {% if k.reporte.count > 0 %}
                        <span class="flex items-center gap-1">
                            <span class="w-2 h-2 bg-warning"></span>
                            {{ k.reporte.count }} reporte{{ k.reporte.count > 1 ? 's' : '' }}
                        </span>
                        {% endif %}
                        {% if k.a_remedier.count > 0 %}
                        <span class="flex items-center gap-1">
                            <span class="w-2 h-2 bg-danger"></span>
                            {{ k.a_remedier.count }} a remedier
                        </span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

    </div>
</div>
{% endblock %}
