{% extends 'campagne/_layout.html.twig' %}

{% block title %}Dashboard - {{ campagne.nom }} - OpsTracker{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Live indicator pulse - RG-040 */
    @keyframes pulse-live {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .live-pulse {
        animation: pulse-live 2s ease-in-out infinite;
    }

    /* Cards */
    .card-elevated {
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
    }

    /* Segment row hover */
    .segment-row {
        transition: background 0.15s ease;
    }
    .segment-row:hover {
        background: #fafaf5;
    }

    /* Status accent colors */
    .status-realise { border-left: 4px solid #059669; }
    .status-planifie { border-left: 4px solid #2563eb; }
    .status-reporte { border-left: 4px solid #d97706; }
    .status-remedier { border-left: 4px solid #dc2626; }

</style>
{% endblock %}

{% block main %}
{# ========================================
   CAMPAIGN HEADER
   ======================================== #}
<header class="bg-white border-b-4 border-ink">
    {# Top bar #}
    <div class="px-10 py-6 flex justify-between items-start">
        <div>
            {# Breadcrumb #}
            <div class="flex items-center gap-2 text-sm text-muted mb-3">
                <a href="{{ path('app_campagne_index') }}" class="hover:text-ink">Campagnes</a>
                <i data-feather="chevron-right" class="w-4 h-4"></i>
                <span class="text-ink font-medium">{{ campagne.nom }}</span>
            </div>

            {# Title + Status - RG-080 Triple signalisation #}
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold tracking-tight">{{ campagne.nom }}</h1>
                <span class="px-3 py-1 bg-{{ campagne.statutCouleur }} text-white text-[10px] font-bold uppercase tracking-wider flex items-center gap-1">
                    {% if campagne.statut == 'en_cours' %}
                        <i data-feather="play-circle" class="w-3 h-3"></i>
                    {% elseif campagne.statut == 'terminee' %}
                        <i data-feather="check-circle" class="w-3 h-3"></i>
                    {% else %}
                        <i data-feather="clock" class="w-3 h-3"></i>
                    {% endif %}
                    {{ campagne.statutLabel }}
                </span>
            </div>

            {# Meta #}
            <div class="flex items-center gap-6 mt-3 text-sm text-muted">
                {% if campagne.typeOperation %}
                <span class="flex items-center gap-2">
                    <i data-feather="monitor" class="w-4 h-4"></i>
                    {{ campagne.typeOperation.nom }}
                </span>
                {% endif %}
                <span class="flex items-center gap-2">
                    <i data-feather="calendar" class="w-4 h-4"></i>
                    {{ campagne.dateDebut|date('d M Y') }} &rarr; {{ campagne.dateFin|date('d M Y') }}
                </span>
                <span class="flex items-center gap-2">
                    <i data-feather="users" class="w-4 h-4"></i>
                    {{ equipe|length }} technicien{{ equipe|length > 1 ? 's' : '' }}
                </span>
                <span class="flex items-center gap-2">
                    <i data-feather="target" class="w-4 h-4"></i>
                    {{ kpi.total }} operation{{ kpi.total > 1 ? 's' : '' }}
                </span>
            </div>
        </div>

        {# Actions #}
        <div class="flex items-center gap-3">
            {# Partager - US-605, RG-041 #}
            <button type="button" onclick="openShareModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors" title="Partager">
                <i data-feather="share-2" class="w-4 h-4"></i>
                Partager
            </button>
            <a href="{{ path('app_dashboard_export_pdf', {id: campagne.id}) }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-muted border-2 border-ink/10 hover:border-ink hover:text-ink transition-colors" title="Exporter en PDF">
                <i data-feather="download" class="w-4 h-4"></i>
                Export PDF
            </a>
            <a href="{{ path('app_campagne_show', {id: campagne.id}) }}" class="flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-ink hover:bg-ink/90 transition-colors">
                <i data-feather="settings" class="w-4 h-4"></i>
                Configurer
            </a>
        </div>
    </div>

    {# Onglets navigation campagne #}
    {% include 'campagne/_tabs.html.twig' with {campagne: campagne, active: 'dashboard'} only %}
</header>

{# ========================================
   CONTENT
   ======================================== #}
<div class="flex-1 overflow-auto">
    <div class="px-10 py-8">

        {# Live indicator - RG-040 #}
        <turbo-frame id="live-indicator" src="{{ path('app_dashboard_refresh', {id: campagne.id}) }}" data-turbo-poll-interval="30000">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-2 h-2 bg-success rounded-full live-pulse"></div>
                <span class="text-xs font-medium text-muted uppercase tracking-wider">Donnees temps reel</span>
                <span class="text-xs text-muted" id="last-update">â€¢ Mise a jour maintenant</span>
            </div>
        </turbo-frame>

        {# ========================================
           4 WIDGETS STATUTS (T-705, US-601)
           RGAA: icone + couleur + texte (RG-080)
           ======================================== #}
        <turbo-frame id="kpi-widgets">
            <div class="grid grid-cols-4 gap-6 mb-10">

                {# Widget REALISE #}
                <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-success"></div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-success/10 flex items-center justify-center">
                            <i data-feather="check-circle" class="w-6 h-6 text-success"></i>
                        </div>
                        {% if kpi.realise.today > 0 %}
                        <span class="text-xs font-semibold text-success uppercase tracking-wider">+{{ kpi.realise.today }} aujourd'hui</span>
                        {% endif %}
                    </div>
                    <p class="text-5xl font-bold num text-ink mb-1">{{ kpi.realise.count }}</p>
                    <p class="text-sm font-medium text-muted uppercase tracking-wide">{{ kpi.realise.label }}</p>
                    <div class="mt-4 pt-4 border-t border-ink/10">
                        <div class="h-1.5 bg-paper">
                            <div class="h-full bg-success" style="width: {{ kpi.realise.percentage }}%"></div>
                        </div>
                        <p class="text-xs text-muted mt-2">{{ kpi.realise.percentage }}% du total</p>
                    </div>
                </div>

                {# Widget PLANIFIE #}
                <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-primary"></div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-primary/10 flex items-center justify-center">
                            <i data-feather="clock" class="w-6 h-6 text-primary"></i>
                        </div>
                    </div>
                    <p class="text-5xl font-bold num text-ink mb-1">{{ kpi.planifie.count }}</p>
                    <p class="text-sm font-medium text-muted uppercase tracking-wide">{{ kpi.planifie.label }}</p>
                    <div class="mt-4 pt-4 border-t border-ink/10">
                        <div class="h-1.5 bg-paper">
                            <div class="h-full bg-primary" style="width: {{ kpi.planifie.percentage }}%"></div>
                        </div>
                        <p class="text-xs text-muted mt-2">{{ kpi.planifie.percentage }}% du total</p>
                    </div>
                </div>

                {# Widget REPORTE #}
                <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-warning"></div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-warning/10 flex items-center justify-center">
                            <i data-feather="pause-circle" class="w-6 h-6 text-warning"></i>
                        </div>
                        {% if kpi.reporte.week > 0 %}
                        <span class="text-xs font-semibold text-warning uppercase tracking-wider">+{{ kpi.reporte.week }} cette semaine</span>
                        {% endif %}
                    </div>
                    <p class="text-5xl font-bold num text-ink mb-1">{{ kpi.reporte.count }}</p>
                    <p class="text-sm font-medium text-muted uppercase tracking-wide">{{ kpi.reporte.label }}</p>
                    <div class="mt-4 pt-4 border-t border-ink/10">
                        <div class="h-1.5 bg-paper">
                            <div class="h-full bg-warning" style="width: {{ kpi.reporte.percentage }}%"></div>
                        </div>
                        <p class="text-xs text-muted mt-2">{{ kpi.reporte.percentage }}% du total</p>
                    </div>
                </div>

                {# Widget A REMEDIER #}
                <div class="card-elevated border-2 border-ink p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-danger"></div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-danger/10 flex items-center justify-center">
                            <i data-feather="alert-triangle" class="w-6 h-6 text-danger"></i>
                        </div>
                        {% if kpi.a_remedier.count > 0 %}
                        <span class="text-xs font-semibold text-danger uppercase tracking-wider">Action requise</span>
                        {% endif %}
                    </div>
                    <p class="text-5xl font-bold num text-ink mb-1">{{ kpi.a_remedier.count }}</p>
                    <p class="text-sm font-medium text-muted uppercase tracking-wide">{{ kpi.a_remedier.label }}</p>
                    <div class="mt-4 pt-4 border-t border-ink/10">
                        <div class="h-1.5 bg-paper">
                            <div class="h-full bg-danger" style="width: {{ kpi.a_remedier.percentage }}%"></div>
                        </div>
                        <p class="text-xs text-muted mt-2">{{ kpi.a_remedier.percentage }}% du total</p>
                    </div>
                </div>
            </div>
        </turbo-frame>

        {# ========================================
           GRAPHIQUE EVOLUTION DES REALISATIONS
           ======================================== #}
        <div class="bg-white border-2 border-ink p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-ink flex items-center gap-2">
                    <i data-feather="trending-up" class="w-5 h-5"></i>
                    Evolution des realisations
                </h3>
                <span class="text-sm text-muted">14 derniers jours</span>
            </div>

            <div class="h-64">
                {% if evolutionData is defined and evolutionData.labels|length > 0 %}
                    <canvas data-controller="chart"
                            data-chart-type-value="line"
                            data-chart-data-value="{{ evolutionData|json_encode|e('html_attr') }}"
                            data-chart-options-value="{{ evolutionOptions|json_encode|e('html_attr') }}">
                    </canvas>
                {% else %}
                    <div class="flex items-center justify-center h-full text-muted">
                        <div class="text-center">
                            <i data-feather="bar-chart-2" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-sm">Aucune donnee disponible</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {# ========================================
           GRID: Segments + Activite recente
           ======================================== #}
        <div class="grid grid-cols-12 gap-8">

            {# PROGRESSION PAR SEGMENT (T-702, US-602) #}
            <div class="col-span-8">
                <turbo-frame id="segments-list" src="{{ path('app_dashboard_segments', {id: campagne.id}) }}">
                    {% include 'dashboard/_segments.html.twig' %}
                </turbo-frame>
            </div>

            {# COLONNE DROITE #}
            <div class="col-span-4 space-y-6">

                {# Activite recente #}
                <turbo-frame id="activite-recente" src="{{ path('app_dashboard_activite', {id: campagne.id}) }}">
                    {% include 'dashboard/_activite.html.twig' %}
                </turbo-frame>

                {# Equipe #}
                {% include 'dashboard/_equipe.html.twig' %}
            </div>
        </div>

    </div>
</div>

{# Modal de partage - US-605, RG-041 #}
<div id="share-modal-container" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-ink/50" onclick="closeShareModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <div class="pointer-events-auto" data-modal>
            <turbo-frame id="share-modal" src="{{ path('app_share_modal', {id: campagne.id}) }}">
                <div class="bg-white border-2 border-ink p-8 text-center">
                    <div class="animate-spin w-8 h-8 border-2 border-ink border-t-transparent rounded-full mx-auto"></div>
                    <p class="mt-4 text-muted">Chargement...</p>
                </div>
            </turbo-frame>
        </div>
    </div>
</div>

<script>
function openShareModal() {
    document.getElementById('share-modal-container').classList.remove('hidden');
}
function closeShareModal() {
    document.getElementById('share-modal-container').classList.add('hidden');
}
// Fermer avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeShareModal();
});
</script>
{% endblock %}
