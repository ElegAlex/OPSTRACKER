{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    Gerer les etapes : {{ template.nom }} <small class="text-muted">(v{{ template.version }})</small>
{% endblock %}

{% block page_actions %}
    <a href="{{ ea_url()
        .setController('App\\\\Controller\\\\Admin\\\\ChecklistTemplateCrudController')
        .setAction('index') }}" class="btn btn-secondary">
        <i class="fa fa-arrow-left"></i> Retour a la liste
    </a>
{% endblock %}

{% block main %}
<div class="container-fluid px-0">
    {# Messages flash #}
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ type == 'success' ? 'success' : 'danger' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endfor %}

    {# Resume du template #}
    <div class="card mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span>
                <i class="fa fa-list-check"></i>
                {{ phases|length }} phase(s) - {{ template.nombreEtapes }} etape(s)
            </span>
            <span class="badge bg-{{ template.actif ? 'success' : 'secondary' }}">
                {{ template.actif ? 'Actif' : 'Inactif' }}
            </span>
        </div>
    </div>

    {# Formulaire ajout phase #}
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa fa-plus"></i> Ajouter une phase
        </div>
        <div class="card-body">
            <form action="{{ path('admin_checklist_phase_add', {id: template.id}) }}" method="POST" class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Nom de la phase *</label>
                    <input type="text" name="nom" class="form-control" required placeholder="Ex: Preparation, Deploiement...">
                </div>
                <div class="col-md-3">
                    <div class="form-check mt-4">
                        <input type="checkbox" name="verrouillable" value="1" class="form-check-input" id="newPhaseVerrouillable">
                        <label class="form-check-label" for="newPhaseVerrouillable">
                            <i class="fa fa-lock"></i> Verrouillable (RG-032)
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa fa-plus"></i> Ajouter la phase
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# Liste des phases #}
    {% if phases is empty %}
        <div class="alert alert-info">
            <i class="fa fa-info-circle"></i> Aucune phase definie. Commencez par ajouter une phase ci-dessus.
        </div>
    {% else %}
        {% for phase in phases %}
            <div class="card mb-4 border-dark">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    {# Formulaire edition phase inline #}
                    <form action="{{ path('admin_checklist_phase_edit', {id: template.id, phaseId: phase.id}) }}" method="POST" class="d-flex align-items-center flex-grow-1 me-3">
                        <span class="badge bg-dark me-2">{{ phase.ordre }}</span>
                        <input type="text" name="nom" value="{{ phase.nom }}" class="form-control form-control-sm me-2" style="max-width: 300px;" required>
                        <div class="form-check me-2">
                            <input type="checkbox" name="verrouillable" value="1" class="form-check-input" id="phase_{{ phase.id }}_verr"
                                   {{ phase.verrouillable ? 'checked' : '' }}>
                            <label class="form-check-label text-white small" for="phase_{{ phase.id }}_verr">
                                <i class="fa fa-lock"></i>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-light" title="Sauvegarder">
                            <i class="fa fa-save"></i>
                        </button>
                    </form>

                    {# Boutons actions phase #}
                    <div class="btn-group btn-group-sm">
                        <form action="{{ path('admin_checklist_phase_up', {id: template.id, phaseId: phase.id}) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-outline-light" {{ loop.first ? 'disabled' : '' }} title="Monter">
                                <i class="fa fa-arrow-up"></i>
                            </button>
                        </form>
                        <form action="{{ path('admin_checklist_phase_down', {id: template.id, phaseId: phase.id}) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-outline-light" {{ loop.last ? 'disabled' : '' }} title="Descendre">
                                <i class="fa fa-arrow-down"></i>
                            </button>
                        </form>
                        <form action="{{ path('admin_checklist_phase_delete', {id: template.id, phaseId: phase.id}) }}" method="POST" class="d-inline"
                              onsubmit="return confirm('Supprimer cette phase et toutes ses etapes ?')">
                            <button type="submit" class="btn btn-outline-danger" title="Supprimer">
                                <i class="fa fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-body">
                    {# Liste des etapes de la phase #}
                    {% if phase.etapes is defined and phase.etapes is not empty %}
                        <table class="table table-sm table-striped mb-3">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px">#</th>
                                    <th>Titre</th>
                                    <th>Description</th>
                                    <th style="width: 80px">Oblig.</th>
                                    <th style="width: 180px">Document</th>
                                    <th style="width: 160px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for etape in phase.etapes %}
                                <tr>
                                    <form action="{{ path('admin_checklist_etape_edit', {id: template.id, phaseId: phase.id, etapeId: etape.id}) }}" method="POST">
                                        <td class="align-middle">
                                            <span class="badge bg-{{ etape.obligatoire ? 'danger' : 'secondary' }}">{{ etape.ordre }}</span>
                                        </td>
                                        <td>
                                            <input type="text" name="titre" value="{{ etape.titre }}" class="form-control form-control-sm" required>
                                        </td>
                                        <td>
                                            <input type="text" name="description" value="{{ etape.description }}" class="form-control form-control-sm" placeholder="(optionnel)">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="checkbox" name="obligatoire" value="1" class="form-check-input" {{ etape.obligatoire ? 'checked' : '' }}>
                                        </td>
                                        <td>
                                            <select name="documentId" class="form-select form-select-sm">
                                                <option value="">— Aucun —</option>
                                                {% for doc in documents %}
                                                    <option value="{{ doc.id }}" {{ etape.documentId|default(null) == doc.id ? 'selected' : '' }}>
                                                        {{ doc.nomOriginal|length > 25 ? doc.nomOriginal|slice(0, 22) ~ '...' : doc.nomOriginal }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="submit" class="btn btn-outline-primary" title="Sauvegarder">
                                                    <i class="fa fa-save"></i>
                                                </button>
                                    </form>
                                                <form action="{{ path('admin_checklist_etape_up', {id: template.id, phaseId: phase.id, etapeId: etape.id}) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-secondary" {{ loop.first ? 'disabled' : '' }} title="Monter">
                                                        <i class="fa fa-arrow-up"></i>
                                                    </button>
                                                </form>
                                                <form action="{{ path('admin_checklist_etape_down', {id: template.id, phaseId: phase.id, etapeId: etape.id}) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-secondary" {{ loop.last ? 'disabled' : '' }} title="Descendre">
                                                        <i class="fa fa-arrow-down"></i>
                                                    </button>
                                                </form>
                                                <form action="{{ path('admin_checklist_etape_delete', {id: template.id, phaseId: phase.id, etapeId: etape.id}) }}" method="POST" class="d-inline"
                                                      onsubmit="return confirm('Supprimer cette etape ?')">
                                                    <button type="submit" class="btn btn-outline-danger" title="Supprimer">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted mb-3"><i class="fa fa-info-circle"></i> Aucune etape dans cette phase.</p>
                    {% endif %}

                    {# Formulaire ajout etape #}
                    <div class="border-top pt-3">
                        <form action="{{ path('admin_checklist_etape_add', {id: template.id, phaseId: phase.id}) }}" method="POST" class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small">Titre *</label>
                                <input type="text" name="titre" class="form-control form-control-sm" required placeholder="Titre de l'etape">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Description</label>
                                <input type="text" name="description" class="form-control form-control-sm" placeholder="(optionnel)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Document</label>
                                <select name="documentId" class="form-select form-select-sm">
                                    <option value="">— Aucun —</option>
                                    {% for doc in documents %}
                                        <option value="{{ doc.id }}">{{ doc.nomOriginal|length > 20 ? doc.nomOriginal|slice(0, 17) ~ '...' : doc.nomOriginal }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check mt-3">
                                    <input type="checkbox" name="obligatoire" value="1" class="form-check-input" id="newEtape_{{ phase.id }}_oblig" checked>
                                    <label class="form-check-label small" for="newEtape_{{ phase.id }}_oblig">Obligatoire</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-success btn-sm w-100">
                                    <i class="fa fa-plus"></i> Ajouter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>
{% endblock %}
