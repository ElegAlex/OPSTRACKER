{#
    Vue "Mes interventions" pour Karim (Technicien IT)
    Vue consolidee multi-campagnes avec KPIs

    US-401 : Voir mes interventions du jour
    RG-020 : Vue filtree sur les operations assignees
    RG-080 : Triple signalisation (icone + couleur + texte)
    RG-082 : Touch targets 44x44px minimum
#}
{% extends 'terrain/_layout.html.twig' %}

{% block title %}Mes interventions - OpsTracker{% endblock %}

{% block header_title %}Mes interventions{% endblock %}

{% block subheader %}
    {# KPIs #}
    <div class="bg-white border-b-2 border-ink px-4 py-4">
        <div class="mb-3">
            <p class="text-xs text-muted uppercase tracking-wider font-semibold">Aujourd'hui</p>
            <p class="text-xl font-bold text-ink">{{ today|format_datetime('full', 'none', locale='fr') }}</p>
        </div>

        <div class="grid grid-cols-4 gap-2">
            {# Total #}
            <div class="bg-ink/5 p-3 text-center">
                <p class="text-2xl font-bold text-ink num">{{ kpis.total }}</p>
                <p class="text-[10px] text-muted font-medium uppercase">Total</p>
            </div>

            {# A faire #}
            <div class="bg-primary/10 p-3 text-center">
                <p class="text-2xl font-bold text-primary num">{{ kpis.a_faire }}</p>
                <p class="text-[10px] text-primary font-medium uppercase">A faire</p>
            </div>

            {# En cours #}
            <div class="bg-warning/10 p-3 text-center">
                <p class="text-2xl font-bold text-warning num">{{ kpis.en_cours }}</p>
                <p class="text-[10px] text-warning font-medium uppercase">En cours</p>
            </div>

            {# Retard #}
            <div class="bg-danger/10 p-3 text-center">
                <p class="text-2xl font-bold text-danger num">{{ kpis.retard }}</p>
                <p class="text-[10px] text-danger font-medium uppercase">Retard</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    {# Messages flash #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="mb-4 p-3 border-2 border-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'ink')) }} bg-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'primary')) }}/10">
                <p class="text-sm font-medium text-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'ink')) }}">
                    {{ message }}
                </p>
            </div>
        {% endfor %}
    {% endfor %}

    {# ==========================================
       SECTION RETARD
       ========================================== #}
    {% if operationsRetard|length > 0 %}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-3 px-1">
            <div class="w-8 h-8 bg-danger/10 flex items-center justify-center">
                <i data-feather="alert-triangle" class="w-5 h-5 text-danger"></i>
            </div>
            <h2 class="font-bold text-danger uppercase tracking-wide text-sm">
                En retard <span class="text-danger/60">({{ operationsRetard|length }})</span>
            </h2>
        </div>

        {# Cards #}
        <div class="space-y-3">
            {% for op in operationsRetard %}
            <a href="{{ path('terrain_show', {id: op.id}) }}"
               class="block bg-white border-l-4 border-danger shadow-sm min-h-[56px] hover:shadow-md hover:translate-x-1 transition-all active:bg-danger/5">
                <div class="flex justify-between items-start gap-4 p-4">
                    {# Contenu principal #}
                    <div class="flex-1 min-w-0">
                        {# Campagne #}
                        <p class="text-[10px] font-semibold text-danger uppercase tracking-wider mb-1">
                            {{ op.campagne.nom }}
                        </p>
                        {# Identifiant principal #}
                        <h3 class="font-bold text-ink text-lg leading-tight mb-0.5">
                            {{ op.displayIdentifier|default('Op #' ~ op.id) }}
                        </h3>
                        {# Nom secondaire #}
                        {% if op.displayName %}
                        <p class="text-sm text-muted truncate">{{ op.displayName }}</p>
                        {% endif %}
                    </div>

                    {# Infos droite #}
                    <div class="flex flex-col items-end gap-2 shrink-0">
                        {# Date planifiee #}
                        {% if op.datePlanifiee %}
                        <div class="flex items-center gap-1 text-danger">
                            <i data-feather="calendar" class="w-3 h-3"></i>
                            <span class="text-xs font-bold">{{ op.datePlanifiee|date('d/m') }}</span>
                        </div>
                        {% endif %}
                        {# Badge statut #}
                        {% include 'terrain/_status_badge.html.twig' with {statut: op.statut} %}
                    </div>
                </div>

                {# Barre de progression checklist si presente #}
                {% if op.checklistInstance %}
                {% set completed = op.checklistInstance.progression.completed|default(0) %}
                {% set total = op.checklistInstance.progression.total|default(0) %}
                {% set pct = total > 0 ? ((completed / total) * 100)|round : 0 %}
                <div class="px-4 pb-3">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-ink/10">
                            <div class="h-full bg-danger transition-all" style="width: {{ pct }}%"></div>
                        </div>
                        <span class="text-[10px] font-bold text-muted num">{{ completed }}/{{ total }}</span>
                    </div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ==========================================
       SECTION AUJOURD'HUI
       ========================================== #}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-3 px-1">
            <div class="w-8 h-8 bg-primary/10 flex items-center justify-center">
                <i data-feather="calendar" class="w-5 h-5 text-primary"></i>
            </div>
            <h2 class="font-bold text-ink uppercase tracking-wide text-sm">
                Aujourd'hui <span class="text-muted">({{ operationsAujourdhui|length }})</span>
            </h2>
        </div>

        {% if operationsAujourdhui|length > 0 %}
        {# Cards #}
        <div class="space-y-3">
            {% for op in operationsAujourdhui %}
            <a href="{{ path('terrain_show', {id: op.id}) }}"
               class="block bg-white border-l-4 border-{{ op.statutCouleur }} shadow-sm min-h-[56px] hover:shadow-md hover:translate-x-1 transition-all active:bg-paper">
                <div class="flex justify-between items-start gap-4 p-4">
                    {# Contenu principal #}
                    <div class="flex-1 min-w-0">
                        {# Campagne #}
                        <p class="text-[10px] font-semibold text-{{ op.statutCouleur }} uppercase tracking-wider mb-1">
                            {{ op.campagne.nom }}
                        </p>
                        {# Identifiant principal #}
                        <h3 class="font-bold text-ink text-lg leading-tight mb-0.5">
                            {{ op.displayIdentifier|default('Op #' ~ op.id) }}
                        </h3>
                        {# Nom secondaire #}
                        {% if op.displayName %}
                        <p class="text-sm text-muted truncate">{{ op.displayName }}</p>
                        {% endif %}
                    </div>

                    {# Infos droite #}
                    <div class="flex flex-col items-end gap-2 shrink-0">
                        {# Badge statut #}
                        {% include 'terrain/_status_badge.html.twig' with {statut: op.statut} %}
                        {# Icone fleche #}
                        <i data-feather="chevron-right" class="w-5 h-5 text-muted/50"></i>
                    </div>
                </div>

                {# Barre de progression checklist si presente #}
                {% if op.checklistInstance %}
                {% set completed = op.checklistInstance.progression.completed|default(0) %}
                {% set total = op.checklistInstance.progression.total|default(0) %}
                {% set pct = total > 0 ? ((completed / total) * 100)|round : 0 %}
                <div class="px-4 pb-3">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-ink/10">
                            <div class="h-full bg-{{ op.statutCouleur }} transition-all" style="width: {{ pct }}%"></div>
                        </div>
                        <span class="text-[10px] font-bold text-muted num">{{ completed }}/{{ total }}</span>
                    </div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
        {% else %}
        {# Etat vide #}
        <div class="bg-white border-2 border-ink/10 p-8 text-center">
            <div class="w-12 h-12 bg-success/10 mx-auto mb-3 flex items-center justify-center">
                <i data-feather="check-circle" class="w-6 h-6 text-success"></i>
            </div>
            <p class="text-muted font-medium">Aucune intervention prevue aujourd'hui</p>
        </div>
        {% endif %}
    </div>

    {# ==========================================
       SECTION A VENIR
       ========================================== #}
    {% if operationsAVenir|length > 0 %}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-3 px-1">
            <div class="w-8 h-8 bg-muted/10 flex items-center justify-center">
                <i data-feather="clock" class="w-5 h-5 text-muted"></i>
            </div>
            <h2 class="font-bold text-muted uppercase tracking-wide text-sm">
                A venir <span class="text-muted/60">({{ operationsAVenir|length }})</span>
            </h2>
        </div>

        {# Cards #}
        <div class="space-y-3">
            {% for op in operationsAVenir %}
            <a href="{{ path('terrain_show', {id: op.id}) }}"
               class="block bg-white border-l-4 border-muted/30 shadow-sm min-h-[56px] hover:shadow-md hover:translate-x-1 hover:border-primary/50 transition-all active:bg-paper">
                <div class="flex justify-between items-start gap-4 p-4">
                    {# Contenu principal #}
                    <div class="flex-1 min-w-0">
                        {# Campagne #}
                        <p class="text-[10px] font-semibold text-muted uppercase tracking-wider mb-1">
                            {{ op.campagne.nom }}
                        </p>
                        {# Identifiant principal #}
                        <h3 class="font-bold text-ink text-lg leading-tight mb-0.5">
                            {{ op.displayIdentifier|default('Op #' ~ op.id) }}
                        </h3>
                        {# Nom secondaire #}
                        {% if op.displayName %}
                        <p class="text-sm text-muted truncate">{{ op.displayName }}</p>
                        {% endif %}
                    </div>

                    {# Infos droite #}
                    <div class="flex flex-col items-end gap-2 shrink-0">
                        {# Date planifiee #}
                        {% if op.datePlanifiee %}
                        <div class="flex items-center gap-1 text-muted">
                            <i data-feather="calendar" class="w-3 h-3"></i>
                            <span class="text-xs font-medium">{{ op.datePlanifiee|date('d/m') }}</span>
                        </div>
                        {% endif %}
                        {# Badge statut #}
                        {% include 'terrain/_status_badge.html.twig' with {statut: op.statut} %}
                    </div>
                </div>

                {# Barre de progression checklist si presente #}
                {% if op.checklistInstance %}
                {% set completed = op.checklistInstance.progression.completed|default(0) %}
                {% set total = op.checklistInstance.progression.total|default(0) %}
                {% set pct = total > 0 ? ((completed / total) * 100)|round : 0 %}
                <div class="px-4 pb-3">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-ink/10">
                            <div class="h-full bg-muted transition-all" style="width: {{ pct }}%"></div>
                        </div>
                        <span class="text-[10px] font-bold text-muted num">{{ completed }}/{{ total }}</span>
                    </div>
                </div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ==========================================
       ETAT VIDE GLOBAL
       ========================================== #}
    {% if operationsRetard|length == 0 and operationsAujourdhui|length == 0 and operationsAVenir|length == 0 %}
    <div class="text-center py-12">
        <div class="w-16 h-16 bg-success/10 mx-auto mb-4 flex items-center justify-center">
            <i data-feather="sun" class="w-8 h-8 text-success"></i>
        </div>
        <p class="text-lg font-bold text-ink mb-1">Aucune intervention</p>
        <p class="text-sm text-muted">Vous n'avez pas d'intervention assignee pour le moment.</p>
    </div>
    {% endif %}
{% endblock %}
