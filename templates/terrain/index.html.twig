{#
    Vue "Mes interventions" pour Karim (Technicien IT)
    Vue consolidee multi-campagnes avec KPIs

    US-401 : Voir mes interventions du jour
    RG-020 : Vue filtree sur les operations assignees
    RG-080 : Triple signalisation (icone + couleur + texte)
    RG-082 : Touch targets 44x44px minimum
#}
{% extends 'terrain/_layout.html.twig' %}

{% block title %}Mes interventions - OpsTracker{% endblock %}

{% block header_title %}Mes interventions{% endblock %}

{# ==========================================
   PALETTE COULEURS CAMPAGNES (fonds pastel)
   Safelist pour Tailwind: bg-blue-50 bg-emerald-50 bg-violet-50 bg-amber-50 bg-rose-50 bg-cyan-50 bg-orange-50 bg-indigo-50
   ========================================== #}
{% set bgPalette = [
    'bg-blue-50',
    'bg-emerald-50',
    'bg-violet-50',
    'bg-amber-50',
    'bg-rose-50',
    'bg-cyan-50',
    'bg-orange-50',
    'bg-indigo-50'
] %}

{% block subheader %}
    {# KPIs #}
    <div class="bg-white border-b-2 border-ink px-4 py-4">
        <div class="mb-3">
            <p class="text-xs text-muted uppercase tracking-wider font-semibold">Aujourd'hui</p>
            <p class="text-xl font-bold text-ink">{{ today|format_datetime('full', 'none', locale='fr') }}</p>
        </div>

        <div class="grid grid-cols-5 gap-2">
            {# Total #}
            <div class="bg-ink/5 p-3 text-center">
                <p class="text-2xl font-bold text-ink num">{{ kpis.total }}</p>
                <p class="text-[10px] text-muted font-medium uppercase">Total</p>
            </div>

            {# A venir #}
            <div class="bg-muted/10 p-3 text-center">
                <p class="text-2xl font-bold text-muted num">{{ kpis.a_venir }}</p>
                <p class="text-[10px] text-muted font-medium uppercase">A venir</p>
            </div>

            {# A faire (aujourd'hui) #}
            <div class="bg-primary/10 p-3 text-center">
                <p class="text-2xl font-bold text-primary num">{{ kpis.a_faire }}</p>
                <p class="text-[10px] text-primary font-medium uppercase">A faire</p>
            </div>

            {# Retard #}
            <div class="bg-danger/10 p-3 text-center">
                <p class="text-2xl font-bold text-danger num">{{ kpis.retard }}</p>
                <p class="text-[10px] text-danger font-medium uppercase">Retard</p>
            </div>

            {# Termine #}
            <div class="bg-success/10 p-3 text-center">
                <p class="text-2xl font-bold text-success num">{{ kpis.terminees }}</p>
                <p class="text-[10px] text-success font-medium uppercase">Termine</p>
            </div>
        </div>
    </div>
{% endblock %}

{# ==========================================
   MACRO : Ligne operation horizontale
   - section_color : couleur du statut (danger, primary, muted...)
   - bg_class : classe de fond campagne (bg-blue-50, etc.)
   ========================================== #}
{% macro operation_row(op, section_color, bg_class) %}
    <a href="{{ path('terrain_show', {id: op.id}) }}"
       class="flex items-center {{ bg_class }} border-l-4 border-{{ section_color }} min-h-[56px] hover:brightness-95 active:brightness-90 transition-all">

        {# DATE + HEURE - largeur fixe #}
        <div class="w-16 shrink-0 px-2 py-3 text-center border-r border-ink/5">
            {% if op.datePlanifiee %}
            <p class="text-sm font-bold text-{{ section_color }} num leading-tight">{{ op.datePlanifiee|date('d') }}</p>
            <p class="text-[10px] text-muted">{{ op.datePlanifiee|date('M') }}</p>
            <p class="text-[10px] font-medium text-{{ section_color }}">{{ op.datePlanifiee|date('H:i') }}</p>
            {% else %}
            <p class="text-xs text-muted">--</p>
            {% endif %}
        </div>

        {# STATUT - largeur fixe #}
        <div class="w-24 shrink-0 px-2 py-3">
            {% include 'terrain/_status_badge.html.twig' with {statut: op.statut} %}
        </div>

        {# CAMPAGNE - largeur fixe #}
        <div class="w-28 shrink-0 px-2 py-3 border-r border-ink/5">
            <span class="text-[10px] font-semibold text-ink uppercase tracking-wider truncate block">
                {{ op.campagne.nom }}
            </span>
        </div>

        {# IDENTIFIANT + NOM - flexible #}
        <div class="flex-1 min-w-0 px-3 py-3 flex items-center gap-2">
            <span class="font-bold text-ink shrink-0">{{ op.displayIdentifier|default('—') }}</span>
            {% if op.displayName %}
            <span class="text-sm text-muted truncate">{{ op.displayName }}</span>
            {% endif %}
        </div>

        {# CHECKLIST PROGRESS (si checklist configuree sur la campagne) #}
        {% if op.campagne.hasChecklistStructure %}
        {% set completed = op.checklistInstance ? op.checklistInstance.nombreEtapesCochees : 0 %}
        {% set total = op.campagne.nombreEtapesActives %}
        <div class="w-12 shrink-0 px-2 py-3 text-center hidden sm:block">
            <p class="text-xs font-bold text-{{ section_color }} num">{{ completed }}/{{ total }}</p>
            <div class="w-full h-1 bg-ink/10 mt-1">
                <div class="h-full bg-{{ section_color }}" style="width: {{ total > 0 ? ((completed / total) * 100)|round : 0 }}%"></div>
            </div>
        </div>
        {% endif %}

        {# CHEVRON #}
        <div class="shrink-0 px-3 py-3">
            <i data-feather="chevron-right" class="w-5 h-5 text-muted/40"></i>
        </div>
    </a>
{% endmacro %}

{% block content %}
    {# Messages flash #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="mb-4 p-3 border-2 border-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'ink')) }} bg-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'primary')) }}/10">
                <p class="text-sm font-medium text-{{ label == 'success' ? 'success' : (label == 'warning' ? 'warning' : (label == 'danger' ? 'danger' : 'ink')) }}">
                    {{ message }}
                </p>
            </div>
        {% endfor %}
    {% endfor %}

    {# ==========================================
       SECTION RETARD
       ========================================== #}
    {% if operationsRetard|length > 0 %}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-2 px-1">
            <div class="w-6 h-6 bg-danger flex items-center justify-center">
                <i data-feather="alert-triangle" class="w-4 h-4 text-white"></i>
            </div>
            <h2 class="font-bold text-danger uppercase tracking-wide text-xs">
                En retard ({{ operationsRetard|length }})
            </h2>
        </div>

        {# Liste operations #}
        <div class="border-2 border-danger/30 divide-y divide-ink/10 overflow-hidden">
            {% for op in operationsRetard %}
                {% set colorIndex = campagneColors[op.campagne.id]|default(0) %}
                {% set bgClass = bgPalette[colorIndex % bgPalette|length] %}
                {{ _self.operation_row(op, 'danger', bgClass) }}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ==========================================
       SECTION AUJOURD'HUI
       ========================================== #}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-2 px-1">
            <div class="w-6 h-6 bg-primary flex items-center justify-center">
                <i data-feather="calendar" class="w-4 h-4 text-white"></i>
            </div>
            <h2 class="font-bold text-ink uppercase tracking-wide text-xs">
                Aujourd'hui ({{ operationsAujourdhui|length }})
            </h2>
        </div>

        {% if operationsAujourdhui|length > 0 %}
        {# Liste operations #}
        <div class="border-2 border-ink/10 divide-y divide-ink/10 overflow-hidden">
            {% for op in operationsAujourdhui %}
                {% set colorIndex = campagneColors[op.campagne.id]|default(0) %}
                {% set bgClass = bgPalette[colorIndex % bgPalette|length] %}
                {{ _self.operation_row(op, op.statutCouleur, bgClass) }}
            {% endfor %}
        </div>
        {% else %}
        {# Etat vide #}
        <div class="bg-white border-2 border-ink/10 p-6 text-center">
            <div class="w-10 h-10 bg-success/10 mx-auto mb-2 flex items-center justify-center">
                <i data-feather="check-circle" class="w-5 h-5 text-success"></i>
            </div>
            <p class="text-sm text-muted">Aucune intervention aujourd'hui</p>
        </div>
        {% endif %}
    </div>

    {# ==========================================
       SECTION A VENIR
       ========================================== #}
    {% if operationsAVenir|length > 0 %}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-2 px-1">
            <div class="w-6 h-6 bg-muted flex items-center justify-center">
                <i data-feather="clock" class="w-4 h-4 text-white"></i>
            </div>
            <h2 class="font-bold text-muted uppercase tracking-wide text-xs">
                A venir ({{ operationsAVenir|length }})
            </h2>
        </div>

        {# Liste operations #}
        <div class="border-2 border-ink/10 divide-y divide-ink/10 overflow-hidden">
            {% for op in operationsAVenir %}
                {% set colorIndex = campagneColors[op.campagne.id]|default(0) %}
                {% set bgClass = bgPalette[colorIndex % bgPalette|length] %}
                {{ _self.operation_row(op, 'muted', bgClass) }}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ==========================================
       SECTION TERMINE (30 derniers jours)
       ========================================== #}
    {% if operationsTerminees|length > 0 %}
    <div class="mb-6">
        {# Header section #}
        <div class="flex items-center gap-2 mb-2 px-1">
            <div class="w-6 h-6 bg-success flex items-center justify-center">
                <i data-feather="check-circle" class="w-4 h-4 text-white"></i>
            </div>
            <h2 class="font-bold text-success uppercase tracking-wide text-xs">
                Termine ({{ operationsTerminees|length }})
            </h2>
            <span class="text-[10px] text-muted ml-2">30 derniers jours</span>
        </div>

        {# Liste operations terminees #}
        <div class="border-2 border-success/20 divide-y divide-ink/10 overflow-hidden">
            {% for op in operationsTerminees %}
                {% set colorIndex = campagneColors[op.campagne.id]|default(0) %}
                {% set bgClass = bgPalette[colorIndex % bgPalette|length] %}
                <div class="flex items-center {{ bgClass }} border-l-4 border-success min-h-[56px]"
                     data-controller="duree-edit"
                     data-duree-edit-minutes-value="{{ op.dureeInterventionMinutes ?? 0 }}">

                    {# DATE - largeur fixe #}
                    <div class="w-16 shrink-0 px-2 py-3 text-center border-r border-ink/5">
                        {% if op.datePlanifiee %}
                        <p class="text-sm font-bold text-success num leading-tight">{{ op.datePlanifiee|date('d') }}</p>
                        <p class="text-[10px] text-muted">{{ op.datePlanifiee|date('M') }}</p>
                        {% else %}
                        <p class="text-xs text-muted">--</p>
                        {% endif %}
                    </div>

                    {# STATUT - largeur fixe #}
                    <div class="w-24 shrink-0 px-2 py-3">
                        {% include 'terrain/_status_badge.html.twig' with {statut: op.statut} %}
                    </div>

                    {# CAMPAGNE - largeur fixe #}
                    <div class="w-28 shrink-0 px-2 py-3 border-r border-ink/5">
                        <span class="text-[10px] font-semibold text-ink uppercase tracking-wider truncate block">
                            {{ op.campagne.nom }}
                        </span>
                    </div>

                    {# IDENTIFIANT + NOM - flexible #}
                    <div class="flex-1 min-w-0 px-3 py-3 flex items-center gap-2">
                        <span class="font-bold text-ink shrink-0">{{ op.displayIdentifier|default('—') }}</span>
                        {% if op.displayName %}
                        <span class="text-sm text-muted truncate">{{ op.displayName }}</span>
                        {% endif %}
                    </div>

                    {# DUREE - avec edition inline si saisie activee #}
                    {% if op.campagne.saisieTempsActivee %}
                    <div class="w-28 shrink-0 px-2 py-3 hidden sm:block">
                        {# Affichage normal #}
                        <div data-duree-edit-target="display" class="flex items-center justify-end gap-1">
                            <i data-feather="clock" class="w-4 h-4 text-purple-500"></i>
                            <span class="text-sm font-bold text-purple-700">{{ op.dureeFormatee ?? '0min' }}</span>
                            <button type="button"
                                    data-action="duree-edit#edit"
                                    class="ml-1 p-1 text-muted hover:text-purple-600"
                                    title="Modifier la duree">
                                <i data-feather="edit-2" class="w-3 h-3"></i>
                            </button>
                        </div>

                        {# Formulaire edition inline #}
                        <form data-duree-edit-target="form"
                              class="hidden"
                              method="post"
                              action="{{ path('terrain_update_duree', {id: op.id}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('duree' ~ op.id) }}">
                            <input type="hidden" name="duree_minutes" data-duree-edit-target="total" value="{{ op.dureeInterventionMinutes ?? 0 }}">
                            <div class="flex items-center gap-1">
                                <input type="number" min="0" max="99"
                                       data-duree-edit-target="heures"
                                       data-action="input->duree-edit#updateTotal"
                                       class="w-10 px-1 py-1 text-xs border border-ink/20 text-center"
                                       value="{{ op.dureeInterventionMinutes ? (op.dureeInterventionMinutes // 60) : 0 }}">
                                <span class="text-xs text-muted">h</span>
                                <input type="number" min="0" max="59"
                                       data-duree-edit-target="minutes"
                                       data-action="input->duree-edit#updateTotal"
                                       class="w-10 px-1 py-1 text-xs border border-ink/20 text-center"
                                       value="{{ op.dureeInterventionMinutes ? (op.dureeInterventionMinutes % 60) : 0 }}">
                                <span class="text-xs text-muted">m</span>
                                <button type="submit" class="px-2 py-1 bg-success text-white text-xs">
                                    <i data-feather="check" class="w-3 h-3"></i>
                                </button>
                                <button type="button" data-action="duree-edit#cancel" class="px-2 py-1 bg-muted/20 text-muted text-xs">
                                    <i data-feather="x" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    {# CHEVRON - lien vers detail #}
                    <a href="{{ path('terrain_show', {id: op.id}) }}" class="shrink-0 px-3 py-3">
                        <i data-feather="chevron-right" class="w-5 h-5 text-muted/40"></i>
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ==========================================
       ETAT VIDE GLOBAL
       ========================================== #}
    {% if operationsRetard|length == 0 and operationsAujourdhui|length == 0 and operationsAVenir|length == 0 %}
    <div class="text-center py-12">
        <div class="w-14 h-14 bg-success/10 mx-auto mb-4 flex items-center justify-center">
            <i data-feather="sun" class="w-7 h-7 text-success"></i>
        </div>
        <p class="text-lg font-bold text-ink mb-1">Aucune intervention</p>
        <p class="text-sm text-muted">Vous n'avez pas d'intervention assignee.</p>
    </div>
    {% endif %}
{% endblock %}
