# Guide d'Exploitation OpsTracker

Ce document d√©crit l'ensemble des proc√©dures d'exploitation pour maintenir, superviser et administrer une installation OpsTracker en production.

---

## Table des mati√®res

1. [Architecture technique](#1-architecture-technique)
2. [Commandes Docker essentielles](#2-commandes-docker-essentielles)
3. [Gestion des utilisateurs](#3-gestion-des-utilisateurs)
4. [Sauvegardes et restauration](#4-sauvegardes-et-restauration)
5. [Supervision et logs](#5-supervision-et-logs)
6. [T√¢ches planifi√©es](#6-t√¢ches-planifi√©es)
7. [Mises √† jour](#7-mises-√†-jour)
8. [Gestion du cache](#8-gestion-du-cache)
9. [Performance et tuning](#9-performance-et-tuning)
10. [S√©curit√©](#10-s√©curit√©)
11. [Int√©gration SMS et Email](#11-int√©gration-sms-et-email)
12. [D√©pannage](#12-d√©pannage)
13. [Proc√©dures d'urgence](#13-proc√©dures-durgence)

---

## 1. Architecture technique

### 1.1 Vue d'ensemble

OpsTracker est compos√© de 4 conteneurs Docker interconnect√©s :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         R√©seau Docker                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ    Nginx     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   PHP-FPM    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  PostgreSQL  ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  Port 80/443 ‚îÇ    ‚îÇ   Port 9000  ‚îÇ    ‚îÇ  Port 5432   ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                             ‚îÇ                                    ‚îÇ
‚îÇ                             ‚ñº                                    ‚îÇ
‚îÇ                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ                      ‚îÇ    Redis     ‚îÇ                           ‚îÇ
‚îÇ                      ‚îÇ  Port 6379   ‚îÇ                           ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.2 R√¥le des composants

| Composant | Version | R√¥le |
|-----------|---------|------|
| **Nginx** | 1.25-alpine | Serveur web, reverse proxy, terminaison SSL |
| **PHP-FPM** | 8.3-alpine | Ex√©cution de l'application Symfony |
| **PostgreSQL** | 17-alpine | Base de donn√©es relationnelle |
| **Redis** | 7-alpine | Cache applicatif et sessions |

### 1.3 Volumes persistants

Les donn√©es sont stock√©es dans des volumes Docker nomm√©s :

| Volume | Contenu | Critique |
|--------|---------|----------|
| `postgres_data` | Base de donn√©es PostgreSQL | ‚ö†Ô∏è **OUI** |
| `redis_data` | Cache Redis | Non |
| `uploads` | Fichiers upload√©s par les utilisateurs | ‚ö†Ô∏è **OUI** |
| `var_log` | Logs applicatifs Symfony | Non |
| `var_sessions` | Sessions utilisateurs | Non |
| `nginx_logs` | Logs du serveur web | Non |
| `public_assets` | Assets compil√©s (CSS, JS) | Non |

### 1.4 Ports r√©seau

| Port | Service | Usage |
|------|---------|-------|
| 80 | Nginx | HTTP (redirig√© vers 443 en prod HTTPS) |
| 443 | Nginx | HTTPS (si configur√©) |
| 9000 | PHP-FPM | Interne uniquement |
| 5432 | PostgreSQL | Interne uniquement |
| 6379 | Redis | Interne uniquement |

---

## 2. Commandes Docker essentielles

### 2.1 Gestion des conteneurs

Toutes les commandes s'ex√©cutent depuis le r√©pertoire d'installation (par d√©faut `/opt/opstracker`).

```bash
# Se placer dans le r√©pertoire
cd /opt/opstracker

# D√©marrer tous les services
docker compose up -d

# Arr√™ter tous les services
docker compose down

# Red√©marrer tous les services
docker compose restart

# Red√©marrer un service sp√©cifique
docker compose restart app
docker compose restart nginx
docker compose restart postgres
docker compose restart redis

# Voir le statut des conteneurs
docker compose ps

# Voir les logs en temps r√©el (tous les services)
docker compose logs -f

# Voir les logs d'un service sp√©cifique
docker compose logs -f app
docker compose logs -f nginx
docker compose logs -f postgres
```

### 2.2 Acc√®s aux conteneurs

```bash
# Acc√®s shell au conteneur PHP (utilisateur www-data)
docker compose exec app sh

# Acc√®s shell en root
docker compose exec -u root app sh

# Acc√®s √† PostgreSQL
docker compose exec postgres psql -U opstracker -d opstracker

# Acc√®s √† Redis
docker compose exec redis redis-cli
```

### 2.3 Commandes Symfony (via conteneur PHP)

```bash
# Ex√©cuter une commande Symfony
docker compose exec app php bin/console [commande]

# Exemples courants
docker compose exec app php bin/console cache:clear
docker compose exec app php bin/console doctrine:migrations:status
```

### 2.4 Utilisation du Makefile

Un Makefile est fourni pour simplifier les op√©rations courantes :

```bash
# Afficher l'aide
make help

# Commandes principales
make start          # D√©marrer les conteneurs
make stop           # Arr√™ter les conteneurs
make restart        # Red√©marrer
make status         # Afficher le statut
make health         # V√©rifier la sant√© des services

# Acc√®s shell
make shell          # Shell utilisateur dans le conteneur PHP
make shell-root     # Shell root dans le conteneur PHP

# Base de donn√©es
make db-migrate     # Ex√©cuter les migrations
make db-backup      # Cr√©er une sauvegarde
make db-restore FILE=backups/backup.sql  # Restaurer

# Cache
make cache-clear    # Vider le cache Symfony
```

---

## 3. Gestion des utilisateurs

### 3.1 R√¥les disponibles

OpsTracker d√©finit une hi√©rarchie de r√¥les :

| R√¥le | Description | H√©rite de |
|------|-------------|-----------|
| `ROLE_ADMIN` | Administrateur syst√®me, acc√®s complet | Tous les r√¥les |
| `ROLE_GESTIONNAIRE` | Gestionnaire de campagnes | ROLE_USER |
| `ROLE_COORDINATEUR` | Coordinateur d'√©quipe | ROLE_USER |
| `ROLE_TECHNICIEN` | Technicien terrain | ROLE_USER |
| `ROLE_USER` | Utilisateur de base | - |

### 3.2 Cr√©er un administrateur

```bash
# Syntaxe
docker compose exec app php bin/console app:create-admin \
    [email] [nom] [prenom] --password='[mot_de_passe]'

# Exemple
docker compose exec app php bin/console app:create-admin \
    admin@example.com Dupont Jean --password='MonMotDePasse123!'
```

**Exigences du mot de passe (RG-001) :**
- Minimum 8 caract√®res
- Au moins 1 majuscule
- Au moins 1 chiffre
- Au moins 1 caract√®re sp√©cial

### 3.3 Importer des agents depuis un fichier CSV

```bash
# Syntaxe
docker compose exec app php bin/console app:import-agents \
    [fichier.csv] [--separator=";"] [--update]

# Exemple : import initial
docker compose exec -T app php bin/console app:import-agents \
    /var/www/html/import/agents.csv --separator=";"

# Exemple : mise √† jour des agents existants
docker compose exec -T app php bin/console app:import-agents \
    /var/www/html/import/agents.csv --separator=";" --update
```

**Format CSV requis :**

```csv
matricule;email;nom;prenom;service;site;role;typecontrat;telephone
A12345;dupont@example.com;Dupont;Jean;DSI;Paris;ROLE_TECHNICIEN;CDI;0612345678
```

| Colonne | Obligatoire | Description |
|---------|-------------|-------------|
| `matricule` | Oui | Identifiant unique de l'agent |
| `email` | Oui | Adresse email |
| `nom` | Oui | Nom de famille |
| `prenom` | Oui | Pr√©nom |
| `service` | Non | Service d'appartenance |
| `site` | Non | Site g√©ographique |
| `role` | Non | R√¥le (d√©faut: ROLE_USER) |
| `typecontrat` | Non | Type de contrat |
| `telephone` | Non | Num√©ro de t√©l√©phone |

### 3.4 Gestion des comptes via l'interface

L'administration des utilisateurs se fait via l'interface web :

1. Connectez-vous avec un compte administrateur
2. Acc√©dez √† **Administration** > **Utilisateurs**
3. Actions disponibles :
   - Cr√©er un nouvel utilisateur
   - Modifier les informations
   - Changer le r√¥le
   - D√©sactiver un compte
   - R√©initialiser le mot de passe

### 3.5 Comptes bloqu√©s

Un compte est automatiquement bloqu√© apr√®s 5 tentatives de connexion √©chou√©es (RG-006).

**Pour d√©bloquer un compte :**

```bash
# Via SQL direct
docker compose exec postgres psql -U opstracker -d opstracker -c \
    "UPDATE utilisateur SET failed_login_attempts = 0, locked_until = NULL WHERE email = 'user@example.com';"
```

Ou via l'interface d'administration (menu Utilisateurs).

---

## 4. Sauvegardes et restauration

### 4.1 Strat√©gie de sauvegarde recommand√©e

| √âl√©ment | Fr√©quence | R√©tention | M√©thode |
|---------|-----------|-----------|---------|
| Base de donn√©es | Quotidienne | 30 jours | pg_dump |
| Fichiers upload√©s | Quotidienne | 30 jours | rsync/tar |
| Configuration (.env) | √Ä chaque modification | Permanente | Copie manuelle |

### 4.2 Sauvegarde de la base de donn√©es

#### Sauvegarde manuelle

```bash
# Via Makefile
make db-backup

# Le fichier est cr√©√© dans backups/backup_YYYYMMDD_HHMMSS.sql
```

#### Sauvegarde directe

```bash
# Cr√©er le r√©pertoire de sauvegarde
mkdir -p /opt/opstracker/backups

# Sauvegarde avec horodatage
docker compose exec -T postgres pg_dump -U opstracker opstracker \
    > /opt/opstracker/backups/backup_$(date +%Y%m%d_%H%M%S).sql
```

#### Sauvegarde compress√©e

```bash
docker compose exec -T postgres pg_dump -U opstracker opstracker \
    | gzip > /opt/opstracker/backups/backup_$(date +%Y%m%d_%H%M%S).sql.gz
```

### 4.3 Sauvegarde des fichiers upload√©s

```bash
# Sauvegarder le volume uploads
docker run --rm -v opstracker_uploads:/data -v /opt/opstracker/backups:/backup \
    alpine tar cvzf /backup/uploads_$(date +%Y%m%d_%H%M%S).tar.gz -C /data .
```

### 4.4 Sauvegarde de la configuration

```bash
# Copier le fichier .env
cp /opt/opstracker/.env /opt/opstracker/backups/.env.backup_$(date +%Y%m%d)
```

### 4.5 Restauration de la base de donn√©es

#### Via Makefile

```bash
make db-restore FILE=backups/backup_20240115_020000.sql
```

#### Restauration manuelle

```bash
# Arr√™ter l'application pour √©viter les √©critures
docker compose stop app

# Restaurer depuis un fichier SQL
cat /opt/opstracker/backups/backup_20240115_020000.sql | \
    docker compose exec -T postgres psql -U opstracker -d opstracker

# Restaurer depuis un fichier compress√©
gunzip -c /opt/opstracker/backups/backup_20240115_020000.sql.gz | \
    docker compose exec -T postgres psql -U opstracker -d opstracker

# Red√©marrer l'application
docker compose start app
```

### 4.6 Restauration des fichiers upload√©s

```bash
# Arr√™ter l'application
docker compose stop app

# Restaurer le volume
docker run --rm -v opstracker_uploads:/data -v /opt/opstracker/backups:/backup \
    alpine sh -c "rm -rf /data/* && tar xvzf /backup/uploads_20240115_020000.tar.gz -C /data"

# Red√©marrer
docker compose start app
```

### 4.7 Script de sauvegarde automatis√©e

Cr√©er le fichier `/opt/opstracker/scripts/backup.sh` :

```bash
#!/bin/bash
#
# Script de sauvegarde automatis√©e OpsTracker
#

set -e

BACKUP_DIR="/opt/opstracker/backups"
INSTALL_DIR="/opt/opstracker"
RETENTION_DAYS=30
DATE=$(date +%Y%m%d_%H%M%S)

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p "$BACKUP_DIR"

cd "$INSTALL_DIR"

echo "[$(date)] D√©marrage de la sauvegarde..."

# 1. Sauvegarde base de donn√©es
echo "[$(date)] Sauvegarde PostgreSQL..."
docker compose exec -T postgres pg_dump -U opstracker opstracker \
    | gzip > "$BACKUP_DIR/db_$DATE.sql.gz"

# 2. Sauvegarde des uploads
echo "[$(date)] Sauvegarde des fichiers upload√©s..."
docker run --rm \
    -v opstracker_uploads:/data:ro \
    -v "$BACKUP_DIR":/backup \
    alpine tar czf "/backup/uploads_$DATE.tar.gz" -C /data .

# 3. Sauvegarde de la configuration
echo "[$(date)] Sauvegarde de la configuration..."
cp "$INSTALL_DIR/.env" "$BACKUP_DIR/env_$DATE.backup"

# 4. Rotation des anciennes sauvegardes
echo "[$(date)] Rotation des sauvegardes (r√©tention: $RETENTION_DAYS jours)..."
find "$BACKUP_DIR" -name "db_*.sql.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "uploads_*.tar.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "env_*.backup" -mtime +$RETENTION_DAYS -delete

echo "[$(date)] Sauvegarde termin√©e."
echo "Fichiers cr√©√©s :"
ls -lh "$BACKUP_DIR"/*_$DATE*
```

Rendre ex√©cutable et planifier :

```bash
chmod +x /opt/opstracker/scripts/backup.sh

# Ajouter au crontab (sauvegarde quotidienne √† 2h00)
echo "0 2 * * * /opt/opstracker/scripts/backup.sh >> /var/log/opstracker-backup.log 2>&1" | crontab -
```

---

## 5. Supervision et logs

### 5.1 V√©rification de l'√©tat des services

#### Statut des conteneurs

```bash
# Afficher l'√©tat de tous les conteneurs
docker compose ps

# Exemple de sortie attendue (tous healthy)
NAME                 STATUS                   PORTS
opstracker-app-1     Up 5 hours (healthy)     9000/tcp
opstracker-nginx-1   Up 5 hours (healthy)     0.0.0.0:80->80/tcp
opstracker-postgres-1 Up 5 hours (healthy)    5432/tcp
opstracker-redis-1   Up 5 hours (healthy)     6379/tcp
```

#### Health checks int√©gr√©s

Chaque conteneur dispose d'un health check automatique :

| Service | V√©rification | Intervalle |
|---------|--------------|------------|
| Nginx | `nginx -t` | 30 secondes |
| PHP-FPM | Ping FCG `/ping` | 30 secondes |
| PostgreSQL | `pg_isready` | 10 secondes |
| Redis | `redis-cli ping` | 10 secondes |

#### Endpoint de sant√© applicatif

```bash
# V√©rifier que l'application r√©pond
curl -s http://localhost/healthz
# R√©ponse attendue : OK
```

### 5.2 Consultation des logs

#### Logs Docker (temps r√©el)

```bash
# Tous les services
docker compose logs -f

# Service sp√©cifique
docker compose logs -f app
docker compose logs -f nginx
docker compose logs -f postgres

# Avec horodatage
docker compose logs -f --timestamps

# Derni√®res 100 lignes
docker compose logs --tail=100 app
```

#### Logs applicatifs Symfony

Les logs Symfony sont stock√©s dans le volume `var_log` :

```bash
# Acc√©der aux logs depuis le conteneur
docker compose exec app cat var/log/prod.log

# Suivre en temps r√©el
docker compose exec app tail -f var/log/prod.log
```

#### Logs Nginx

```bash
# Logs d'acc√®s
docker compose exec nginx cat /var/log/nginx/access.log

# Logs d'erreur
docker compose exec nginx tail -f /var/log/nginx/error.log
```

#### Logs PostgreSQL

```bash
docker compose logs postgres
```

### 5.3 Format des logs

En production, les logs Symfony sont au format JSON pour faciliter l'int√©gration avec des outils comme ELK, Graylog, ou Datadog :

```json
{
  "message": "User login successful",
  "context": {"user_id": 123, "email": "user@example.com"},
  "level": 200,
  "level_name": "INFO",
  "channel": "security",
  "datetime": "2024-01-15T10:30:00+01:00"
}
```

### 5.4 Surveillance des ressources

```bash
# Utilisation CPU/M√©moire des conteneurs
docker stats

# Espace disque des volumes
docker system df -v

# Espace disque du syst√®me h√¥te
df -h /var/lib/docker
```

### 5.5 Alertes recommand√©es

Configurer des alertes sur les m√©triques suivantes :

| M√©trique | Seuil d'alerte | Action |
|----------|---------------|--------|
| CPU conteneur PHP | > 80% pendant 5 min | V√©rifier les requ√™tes lentes |
| M√©moire conteneur PHP | > 80% | Red√©marrer le conteneur |
| Espace disque /var/lib/docker | > 85% | Nettoyer les images/volumes |
| Conteneur unhealthy | > 3 min | Red√©marrer le service |
| Temps de r√©ponse /healthz | > 5 secondes | Investiguer les performances |

### 5.6 Int√©gration monitoring externe

Pour une supervision avanc√©e, vous pouvez exposer des m√©triques :

```bash
# Exemple avec Prometheus (n√©cessite configuration additionnelle)
# Ajouter au docker-compose.yml :
#   - ./docker/prometheus:/etc/prometheus
#   ports:
#     - "9090:9090"
```

---

## 6. T√¢ches planifi√©es

### 6.1 Rappels automatiques

OpsTracker peut envoyer des rappels automatiques pour les r√©servations :

```bash
# Rappels email (J-2 avant la r√©servation)
docker compose exec app php bin/console app:send-reminders --type=email

# Rappels SMS (J-1 avant la r√©servation)
docker compose exec app php bin/console app:send-reminders --type=sms

# Tous les rappels
docker compose exec app php bin/console app:send-reminders --type=all

# Mode simulation (n'envoie pas r√©ellement)
docker compose exec app php bin/console app:send-reminders --dry-run
```

**Options disponibles :**

| Option | Description | D√©faut |
|--------|-------------|--------|
| `--type=all\|email\|sms` | Type de rappels √† envoyer | all |
| `--email-days=N` | Jours avant r√©servation pour email | 2 |
| `--sms-days=N` | Jours avant r√©servation pour SMS | 1 |
| `--dry-run` | Simulation sans envoi | false |

### 6.2 Configuration crontab recommand√©e

Cr√©er le fichier `/etc/cron.d/opstracker` :

```cron
# OpsTracker - T√¢ches planifi√©es
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Rappels email chaque jour √† 8h00
0 8 * * * root cd /opt/opstracker && docker compose exec -T app php bin/console app:send-reminders --type=email >> /var/log/opstracker-reminders.log 2>&1

# Rappels SMS chaque jour √† 18h00
0 18 * * * root cd /opt/opstracker && docker compose exec -T app php bin/console app:send-reminders --type=sms >> /var/log/opstracker-reminders.log 2>&1

# Sauvegarde quotidienne √† 2h00
0 2 * * * root /opt/opstracker/scripts/backup.sh >> /var/log/opstracker-backup.log 2>&1

# Nettoyage des sauvegardes > 30 jours (1er du mois √† 3h00)
0 3 1 * * root find /opt/opstracker/backups -name "*.sql.gz" -mtime +30 -delete

# Nettoyage des logs Docker (hebdomadaire, dimanche 4h00)
0 4 * * 0 root docker system prune -f >> /var/log/docker-prune.log 2>&1
```

### 6.3 V√©rification des t√¢ches planifi√©es

```bash
# Lister les t√¢ches cron actives
crontab -l
cat /etc/cron.d/opstracker

# Consulter les logs d'ex√©cution
tail -f /var/log/opstracker-reminders.log
tail -f /var/log/opstracker-backup.log
```

---

## 7. Mises √† jour

### 7.1 Processus de mise √† jour standard

```bash
cd /opt/opstracker

# 1. Sauvegarder avant mise √† jour
./scripts/backup.sh

# 2. R√©cup√©rer les derni√®res modifications
git fetch origin
git pull origin main

# 3. Reconstruire les images Docker
docker compose build --no-cache

# 4. Arr√™ter et relancer avec les nouvelles images
docker compose down
docker compose up -d

# 5. Ex√©cuter les migrations de base de donn√©es
docker compose exec app php bin/console doctrine:migrations:migrate --no-interaction

# 6. Vider le cache
docker compose exec app php bin/console cache:clear

# 7. V√©rifier le fonctionnement
curl -s http://localhost/healthz
docker compose ps
```

### 7.2 Mise √† jour via Makefile

```bash
make deploy
```

Cette commande ex√©cute automatiquement :
- `git pull`
- `docker compose build`
- `docker compose up -d`
- `doctrine:migrations:migrate`
- `cache:clear`

### 7.3 Rollback en cas de probl√®me

```bash
# 1. Revenir √† la version pr√©c√©dente du code
git log --oneline -5  # Identifier le commit pr√©c√©dent
git checkout [commit_hash]

# 2. Reconstruire avec l'ancienne version
docker compose build
docker compose up -d

# 3. Si n√©cessaire, restaurer la base de donn√©es
make db-restore FILE=backups/backup_avant_mise_a_jour.sql
```

### 7.4 Mise √† jour des composants Docker

```bash
# Mettre √† jour les images de base
docker compose pull

# Reconstruire avec les nouvelles images de base
docker compose build --no-cache
docker compose up -d
```

---

## 8. Gestion du cache

### 8.1 Types de cache

OpsTracker utilise plusieurs niveaux de cache :

| Cache | Stockage | Contenu |
|-------|----------|---------|
| Symfony | Fichiers (`var/cache/`) | Routes, templates, configurations |
| Redis | M√©moire | Sessions, donn√©es applicatives |
| OPcache | M√©moire PHP | Bytecode PHP compil√© |
| APCu | M√©moire PHP | Cache de requ√™tes Doctrine |

### 8.2 Vider le cache Symfony

```bash
# Via Makefile
make cache-clear

# Via commande directe
docker compose exec app php bin/console cache:clear

# Forcer le warmup
docker compose exec app php bin/console cache:warmup
```

### 8.3 Vider le cache Redis

```bash
# Supprimer toutes les cl√©s Redis
docker compose exec redis redis-cli FLUSHALL

# Supprimer uniquement les cl√©s de cache (conserve les sessions)
docker compose exec redis redis-cli KEYS "cache:*" | xargs docker compose exec redis redis-cli DEL
```

### 8.4 Vider OPcache

```bash
# Red√©marrer PHP-FPM (seule m√©thode fiable)
docker compose restart app
```

### 8.5 Statistiques de cache

```bash
# Statistiques Redis
docker compose exec redis redis-cli INFO stats
docker compose exec redis redis-cli INFO memory

# Nombre de cl√©s Redis
docker compose exec redis redis-cli DBSIZE
```

---

## 9. Performance et tuning

### 9.1 Configuration PHP-FPM

Le fichier `docker/php/www.conf` contr√¥le le pool PHP-FPM :

| Param√®tre | Valeur | Description |
|-----------|--------|-------------|
| `pm` | dynamic | Gestionnaire de processus dynamique |
| `pm.max_children` | 50 | Nombre maximum de workers |
| `pm.start_servers` | 5 | Workers au d√©marrage |
| `pm.min_spare_servers` | 5 | Minimum de workers en attente |
| `pm.max_spare_servers` | 35 | Maximum de workers en attente |
| `pm.max_requests` | 500 | Requ√™tes avant recyclage du worker |
| `request_terminate_timeout` | 300s | Timeout par requ√™te |

**Ajustement selon la RAM disponible :**

| RAM serveur | max_children recommand√© |
|-------------|-------------------------|
| 2 Go | 20 |
| 4 Go | 35 |
| 8 Go | 50 |
| 16 Go | 100 |

### 9.2 Configuration Redis

Redis est configur√© avec une limite de m√©moire de 256 Mo et une politique d'√©viction `allkeys-lru` (supprime les cl√©s les moins r√©cemment utilis√©es).

**Pour augmenter la m√©moire Redis :**

Modifier dans `docker-compose.yml` :

```yaml
redis:
  command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
```

### 9.3 Configuration PostgreSQL

Pour les installations avec beaucoup de donn√©es, ajuster les param√®tres PostgreSQL :

Cr√©er `docker/postgres/postgresql.conf` :

```ini
# M√©moire
shared_buffers = 256MB
effective_cache_size = 768MB
work_mem = 16MB
maintenance_work_mem = 128MB

# Connexions
max_connections = 100

# Logs
log_min_duration_statement = 1000  # Log les requ√™tes > 1 seconde
```

### 9.4 Optimisation des assets

```bash
# Recompiler les assets Tailwind (minifi√©s)
docker compose exec app php bin/console tailwind:build --minify

# Recompiler l'asset map
docker compose exec app php bin/console asset-map:compile
```

### 9.5 Analyse des performances

```bash
# Test de charge int√©gr√©
docker compose exec app php bin/console app:load-test --full

# Sortie exemple :
# ‚úÖ Liste op√©rations: 45ms (OK)
# ‚úÖ Dashboard KPI: 78ms (OK)
# ‚ö†Ô∏è Recherche: 320ms (WARN)
# ‚úÖ Segments: 89ms (OK)
```

**Seuils de performance :**

| Cat√©gorie | Temps |
|-----------|-------|
| ‚úÖ OK | < 100 ms |
| ‚ö†Ô∏è WARN | 100-500 ms |
| üî¥ SLOW | > 500 ms |

### 9.6 Requ√™tes SQL lentes

Pour identifier les requ√™tes lentes :

```bash
# Activer le log des requ√™tes lentes dans PostgreSQL
docker compose exec postgres psql -U opstracker -c \
    "ALTER SYSTEM SET log_min_duration_statement = 500;"

docker compose restart postgres

# Consulter les logs
docker compose logs postgres | grep "duration:"
```

---

## 10. S√©curit√©

### 10.1 Politique de mots de passe

OpsTracker applique les r√®gles suivantes (RG-001) :

- Minimum 8 caract√®res
- Au moins 1 majuscule
- Au moins 1 chiffre
- Au moins 1 caract√®re sp√©cial (@, #, !, etc.)

### 10.2 Protection contre les attaques

| Protection | M√©canisme | Configuration |
|------------|-----------|---------------|
| Brute force | Verrouillage apr√®s 5 √©checs | RG-006, UserChecker |
| CSRF | Tokens par formulaire | Symfony Security |
| XSS | √âchappement automatique Twig | Symfony Twig |
| Injection SQL | Requ√™tes pr√©par√©es | Doctrine ORM |
| Clickjacking | Header X-Frame-Options | Nginx |
| MIME sniffing | Header X-Content-Type-Options | Nginx |

### 10.3 S√©curit√© des sessions

Configuration dans `config/packages/framework.yaml` :

| Option | Valeur | Description |
|--------|--------|-------------|
| `cookie_secure` | auto/true | Cookies uniquement via HTTPS |
| `cookie_httponly` | true | Inaccessible depuis JavaScript |
| `cookie_samesite` | strict | Protection CSRF |

### 10.4 Fichiers sensibles √† prot√©ger

| Fichier | Contenu sensible | Protection |
|---------|------------------|------------|
| `.env` | Mots de passe DB, APP_SECRET | chmod 600, non versionn√© |
| `backups/*.sql` | Donn√©es compl√®tes | chmod 600, chiffrement recommand√© |
| `var/log/*.log` | Traces d'activit√© | chmod 640, rotation |

### 10.5 Rotation du secret applicatif

Le `APP_SECRET` est utilis√© pour signer les tokens CSRF et les cookies. En cas de compromission :

```bash
# 1. G√©n√©rer un nouveau secret
NEW_SECRET=$(php -r "echo bin2hex(random_bytes(16));")

# 2. Mettre √† jour .env
sed -i "s/APP_SECRET=.*/APP_SECRET=$NEW_SECRET/" /opt/opstracker/.env

# 3. Vider le cache et red√©marrer
docker compose exec app php bin/console cache:clear
docker compose restart app

# Note: Les sessions existantes seront invalid√©es
```

### 10.6 Audit et tra√ßabilit√©

OpsTracker enregistre automatiquement les modifications sur les entit√©s principales (RG-070, RG-071) :

**Entit√©s audit√©es :**
- Campagne
- Op√©ration
- Utilisateur
- TypeOperation
- ChecklistTemplate
- ChecklistInstance
- Segment
- Document

**Consulter l'historique :**

```bash
# Via SQL
docker compose exec postgres psql -U opstracker -d opstracker -c \
    "SELECT * FROM audit_operation ORDER BY created_at DESC LIMIT 20;"
```

Ou via l'interface d'administration : **Administration** > **Historique des modifications**

### 10.7 Bonnes pratiques

1. **Mettre √† jour r√©guli√®rement** les images Docker et d√©pendances
2. **Ne jamais exposer** les ports internes (PostgreSQL, Redis) sur Internet
3. **Utiliser HTTPS** en production (voir guide d'installation)
4. **Sauvegarder quotidiennement** et tester les restaurations
5. **Surveiller les logs** pour d√©tecter les tentatives d'intrusion
6. **Limiter les acc√®s SSH** au serveur h√¥te

---

## 11. Int√©gration SMS et Email

### 11.1 Configuration Email

Le transport email est configur√© via la variable `MAILER_DSN` dans `.env`.

#### Exemples de configuration

```bash
# D√©sactiv√© (d√©veloppement)
MAILER_DSN=null://null

# SMTP simple
MAILER_DSN=smtp://smtp.example.com:25

# SMTP authentifi√©
MAILER_DSN=smtp://user:password@smtp.example.com:587

# SMTP avec TLS
MAILER_DSN=smtp://user:password@smtp.example.com:587?encryption=tls

# Gmail (n√©cessite mot de passe d'application)
MAILER_DSN=gmail+smtp://user:app_password@default

# Amazon SES
MAILER_DSN=ses+smtp://ACCESS_KEY:SECRET_KEY@default?region=eu-west-1
```

#### Tester l'envoi d'email

```bash
docker compose exec app php bin/console app:send-reminders --type=email --dry-run
```

### 11.2 Configuration SMS (OVH)

OpsTracker supporte l'envoi de SMS via l'API OVH.

#### Pr√©requis

1. Cr√©er un compte OVH avec le service SMS
2. G√©n√©rer les cl√©s API sur [https://eu.api.ovh.com/createToken/](https://eu.api.ovh.com/createToken/)
   - GET/POST/PUT/DELETE sur `/sms/*`

#### Configuration

Ajouter dans `.env` :

```bash
SMS_ENABLED=true
SMS_PROVIDER=ovh

# Credentials OVH
OVH_APPLICATION_KEY=your_app_key
OVH_APPLICATION_SECRET=your_app_secret
OVH_CONSUMER_KEY=your_consumer_key
OVH_SMS_SERVICE=sms-xx12345-1    # Identifiant du service SMS
OVH_SMS_SENDER=OpsTracker        # Nom de l'exp√©diteur (11 car. max)
```

#### Tester l'envoi de SMS

```bash
# Mode simulation
docker compose exec app php bin/console app:send-reminders --type=sms --dry-run

# Envoi r√©el (attention aux co√ªts)
docker compose exec app php bin/console app:send-reminders --type=sms
```

### 11.3 Messages asynchrones

Les emails et SMS sont envoy√©s de mani√®re asynchrone via Symfony Messenger.

#### Consulter la file d'attente

```bash
# Nombre de messages en attente
docker compose exec postgres psql -U opstracker -d opstracker -c \
    "SELECT COUNT(*) FROM messenger_messages WHERE delivered_at IS NULL;"

# Messages en erreur
docker compose exec postgres psql -U opstracker -d opstracker -c \
    "SELECT * FROM messenger_messages WHERE queue_name = 'failed';"
```

#### Retraiter les messages en √©chec

```bash
# Voir les messages √©chou√©s
docker compose exec app php bin/console messenger:failed:show

# Retraiter un message
docker compose exec app php bin/console messenger:failed:retry [id]

# Retraiter tous les messages
docker compose exec app php bin/console messenger:failed:retry --all
```

---

## 12. D√©pannage

### 12.1 Probl√®mes courants et solutions

#### L'application ne r√©pond pas (erreur 502/504)

```bash
# V√©rifier l'√©tat des conteneurs
docker compose ps

# Si app est unhealthy ou exited, consulter les logs
docker compose logs app

# Red√©marrer le conteneur PHP
docker compose restart app
```

#### Erreur de connexion √† la base de donn√©es

```bash
# V√©rifier que PostgreSQL est accessible
docker compose exec app php bin/console dbal:run-sql "SELECT 1"

# Si erreur, v√©rifier les logs PostgreSQL
docker compose logs postgres

# V√©rifier les credentials dans .env
cat .env | grep DATABASE_URL
```

#### Erreur 500 apr√®s mise √† jour

```bash
# Vider le cache
docker compose exec app php bin/console cache:clear

# V√©rifier les migrations
docker compose exec app php bin/console doctrine:migrations:status

# Ex√©cuter les migrations manquantes
docker compose exec app php bin/console doctrine:migrations:migrate --no-interaction
```

#### Assets CSS/JS non charg√©s

```bash
# Recompiler les assets
docker compose exec app php bin/console assets:install public
docker compose exec app php bin/console tailwind:build --minify
docker compose exec app php bin/console asset-map:compile

# Red√©marrer Nginx
docker compose restart nginx
```

#### Session perdue / Redirection vers login en boucle

```bash
# V√©rifier Redis
docker compose exec redis redis-cli PING
# R√©ponse attendue : PONG

# Si Redis ne r√©pond pas
docker compose restart redis

# V√©rifier la configuration des cookies (HTTPS)
cat .env | grep COOKIE_SECURE
# Pour HTTP : COOKIE_SECURE=false
# Pour HTTPS : COOKIE_SECURE=true
```

#### Espace disque satur√©

```bash
# Identifier ce qui prend de la place
docker system df

# Nettoyer les ressources Docker inutilis√©es
docker system prune -a --volumes

# V√©rifier les logs volumineux
du -sh /var/lib/docker/containers/*/

# Tronquer les logs d'un conteneur
truncate -s 0 /var/lib/docker/containers/[container_id]/*-json.log
```

### 12.2 Commandes de diagnostic

```bash
# Informations syst√®me
docker version
docker compose version
docker info

# R√©seau Docker
docker network inspect opstracker_default

# Volumes Docker
docker volume ls | grep opstracker

# V√©rifier la connectivit√© entre conteneurs
docker compose exec app ping -c 3 postgres
docker compose exec app ping -c 3 redis

# V√©rifier les processus PHP
docker compose exec app ps aux | grep php

# M√©moire utilis√©e par conteneur
docker stats --no-stream
```

### 12.3 R√©cup√©rer des logs pour le support

```bash
# Cr√©er un bundle de diagnostic
mkdir -p /tmp/opstracker-diag
cd /opt/opstracker

# √âtat des conteneurs
docker compose ps > /tmp/opstracker-diag/containers.txt

# Logs des derni√®res 24h
docker compose logs --since 24h > /tmp/opstracker-diag/docker-logs.txt 2>&1

# Logs Symfony
docker compose exec app cat var/log/prod.log > /tmp/opstracker-diag/symfony.log 2>/dev/null || true

# Configuration (sans les secrets)
grep -v PASSWORD .env | grep -v SECRET > /tmp/opstracker-diag/env-sanitized.txt

# Versions
docker version > /tmp/opstracker-diag/docker-version.txt
docker compose exec app php -v > /tmp/opstracker-diag/php-version.txt

# Cr√©er l'archive
tar czf /tmp/opstracker-diagnostic-$(date +%Y%m%d).tar.gz -C /tmp opstracker-diag

echo "Archive cr√©√©e : /tmp/opstracker-diagnostic-$(date +%Y%m%d).tar.gz"
```

---

## 13. Proc√©dures d'urgence

### 13.1 Arr√™t d'urgence

En cas de comportement anormal (attaque, bug critique) :

```bash
# Arr√™ter imm√©diatement l'application (pr√©serve les donn√©es)
cd /opt/opstracker
docker compose stop

# V√©rifier que tous les conteneurs sont arr√™t√©s
docker compose ps
```

### 13.2 Restauration d'urgence

Si l'application est corrompue ou compromise :

```bash
# 1. Arr√™ter compl√®tement
docker compose down

# 2. Identifier la derni√®re bonne sauvegarde
ls -la /opt/opstracker/backups/

# 3. Supprimer les volumes (ATTENTION: perte de donn√©es actuelles)
docker volume rm opstracker_postgres_data
docker volume rm opstracker_redis_data

# 4. Recr√©er les conteneurs
docker compose up -d

# 5. Attendre que PostgreSQL soit pr√™t
sleep 10

# 6. Restaurer la base de donn√©es
cat /opt/opstracker/backups/db_YYYYMMDD_HHMMSS.sql.gz | gunzip | \
    docker compose exec -T postgres psql -U opstracker -d opstracker

# 7. Restaurer les uploads si n√©cessaire
docker run --rm -v opstracker_uploads:/data -v /opt/opstracker/backups:/backup \
    alpine tar xzf /backup/uploads_YYYYMMDD_HHMMSS.tar.gz -C /data

# 8. V√©rifier le fonctionnement
curl http://localhost/healthz
```

### 13.3 Basculement sur un serveur de secours

**Pr√©requis :** Serveur de secours avec Docker install√© et sauvegardes accessibles.

```bash
# Sur le serveur de secours

# 1. Cloner le repository
git clone https://github.com/ElegAlex/OPSTRACKER.git /opt/opstracker
cd /opt/opstracker

# 2. Copier la configuration
scp user@serveur-principal:/opt/opstracker/.env /opt/opstracker/.env

# 3. Copier les sauvegardes
scp user@serveur-principal:/opt/opstracker/backups/db_latest.sql.gz /opt/opstracker/backups/
scp user@serveur-principal:/opt/opstracker/backups/uploads_latest.tar.gz /opt/opstracker/backups/

# 4. D√©marrer les services
docker compose build
docker compose up -d

# 5. Restaurer les donn√©es
gunzip -c /opt/opstracker/backups/db_latest.sql.gz | \
    docker compose exec -T postgres psql -U opstracker -d opstracker

# 6. Mettre √† jour le DNS pour pointer vers le nouveau serveur
```

### 13.4 Contact support

En cas de probl√®me non r√©solu :

1. Cr√©er un bundle de diagnostic (voir section 12.3)
2. Ouvrir une issue sur GitHub : [https://github.com/ElegAlex/OPSTRACKER/issues](https://github.com/ElegAlex/OPSTRACKER/issues)
3. Joindre l'archive de diagnostic (apr√®s avoir v√©rifi√© qu'elle ne contient pas de donn√©es sensibles)

---

## Annexes

### A. R√©f√©rence des commandes Symfony

```bash
# Commandes OpsTracker
app:create-admin         # Cr√©er un administrateur
app:import-agents        # Importer des agents depuis CSV
app:send-reminders       # Envoyer les rappels (email/SMS)
app:sync-segments        # Synchroniser les segments d'une campagne
app:load-test           # Test de charge

# Commandes Doctrine
doctrine:migrations:migrate         # Ex√©cuter les migrations
doctrine:migrations:status          # Statut des migrations
doctrine:migrations:diff            # G√©n√©rer une migration
doctrine:database:create            # Cr√©er la base de donn√©es
doctrine:database:drop              # Supprimer la base de donn√©es

# Commandes Symfony
cache:clear             # Vider le cache
cache:warmup            # Pr√©chauffer le cache
debug:router            # Lister les routes
debug:container         # Lister les services
messenger:consume       # Traiter les messages asynchrones
messenger:failed:show   # Voir les messages en √©chec
messenger:failed:retry  # Retraiter les messages en √©chec

# Commandes Assets
assets:install          # Installer les assets des bundles
tailwind:build          # Compiler Tailwind CSS
asset-map:compile       # Compiler l'asset map
importmap:install       # Installer les d√©pendances JS
```

### B. Variables d'environnement

| Variable | Description | Valeur par d√©faut |
|----------|-------------|-------------------|
| `APP_ENV` | Environnement (prod/dev/test) | prod |
| `APP_DEBUG` | Mode debug | 0 |
| `APP_SECRET` | Cl√© secr√®te Symfony | (g√©n√©r√©) |
| `DATABASE_URL` | URL de connexion PostgreSQL | - |
| `REDIS_URL` | URL de connexion Redis | redis://redis:6379 |
| `MAILER_DSN` | Configuration email | null://null |
| `SMS_ENABLED` | Activer les SMS | false |
| `SMS_PROVIDER` | Fournisseur SMS | log |
| `OVH_APPLICATION_KEY` | Cl√© application OVH | - |
| `OVH_APPLICATION_SECRET` | Secret application OVH | - |
| `OVH_CONSUMER_KEY` | Cl√© consommateur OVH | - |
| `OVH_SMS_SERVICE` | Service SMS OVH | - |
| `OVH_SMS_SENDER` | Nom exp√©diteur SMS | OpsTracker |
| `NGINX_PORT` | Port HTTP | 80 |
| `COOKIE_SECURE` | Cookie s√©curis√© (HTTPS) | false |
| `DEFAULT_URI` | URI par d√©faut | http://localhost |

### C. Ports et protocoles

| Port | Protocole | Service | Exposition |
|------|-----------|---------|------------|
| 80 | HTTP | Nginx | Externe |
| 443 | HTTPS | Nginx | Externe (si SSL) |
| 9000 | FastCGI | PHP-FPM | Interne |
| 5432 | PostgreSQL | PostgreSQL | Interne |
| 6379 | Redis | Redis | Interne |

---

*Document g√©n√©r√© pour OpsTracker v2.2*
*Derni√®re mise √† jour : F√©vrier 2026*
